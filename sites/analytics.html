<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEDIS Analytics - Patientenstatus Timeline</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .timeline-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .zoom-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .zoom-slider {
            width: 200px;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            cursor: pointer;
        }
        .zoom-slider::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .zoom-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .zoom-info {
            font-size: 14px;
            color: #666;
            min-width: 120px;
        }
        .control-button {
            padding: 6px 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .control-button:hover {
            background: #0056b3;
        }
        .comparative-timeline {
            position: relative;
            margin: 30px 0;
            padding: 20px 0;
            overflow-x: auto;
            overflow-y: visible;
            border: 1px solid #ddd;
            border-radius: 4px;
            height: auto;
            max-height: 600px;
        }
        .timeline-content {
            position: relative;
            min-height: 200px;
        }
        .time-axis {
            position: relative;
            height: 40px;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
            background: white;
            z-index: 5;
        }
        .time-marker {
            position: absolute;
            bottom: -25px;
            font-size: 12px;
            color: #666;
            transform: translateX(-50%);
        }
        .time-grid-line {
            position: absolute;
            top: 0;
            bottom: -20px;
            width: 1px;
            background-color: #eee;
        }
        .patient-row {
            position: relative;
            height: 60px;
            margin: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .patient-label {
            position: absolute;
            left: 0;
            width: 120px;
            height: 100%;
            display: flex;
            align-items: center;
            font-weight: bold;
            font-size: 14px;
            background: #f8f9fa;
            border-right: 2px solid #ddd;
            padding: 0 10px;
            box-sizing: border-box;
            z-index: 3;
        }
        .patient-timeline {
            position: relative;
            margin-left: 140px;
            height: 100%;
        }
        .status-point {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            z-index: 2;
        }
        .status-line {
            position: absolute;
            height: 4px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1;
        }
        .status-tooltip {
            position: absolute;
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 8px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 10;
        }
        .status-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: #333;
        }
        .status-point:hover .status-tooltip {
            opacity: 1;
        }
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
        }
        .no-data {
            text-align: center;
            color: #666;
            font-style: italic;
            margin: 50px 0;
        }
        .statistics-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .statistics-section h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-card h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #6c757d;
            font-size: 1.1em;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .stat-item:last-child {
            border-bottom: none;
        }
        .stat-label {
            font-weight: 500;
            color: #495057;
        }
        .stat-value {
            font-weight: bold;
            color: #007bff;
            background: #e3f2fd;
            padding: 4px 8px;
            border-radius: 4px;
            min-width: 30px;
            text-align: center;
        }
        .stat-bar {
            margin-left: 10px;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            flex: 1;
            max-width: 100px;
        }
        .stat-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Timeline</h1>
        <div id="legend" class="legend"></div>
        
        <div class="timeline-controls">
            <div class="zoom-control">
                <label for="zoomSlider">Zoom:</label>
                <input type="range" id="zoomSlider" class="zoom-slider" min="5" max="60" value="30" step="5">
                <span id="zoomInfo" class="zoom-info">30 Min sichtbar</span>
            </div>
            <button id="resetZoom" class="control-button">Reset</button>
            <button id="centerCurrent" class="control-button">Zur aktuellen Zeit</button>
        </div>
        
        <div id="comparativeTimeline"></div>
        
        <div class="statistics-section">
            <h2>Patientenverteilung</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Nach Einsatzorten</h3>
                    <div id="locationStats"></div>
                </div>
                <div class="stat-card">
                    <h3>Nach Diagnosen</h3>
                    <div id="diagnosisStats"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const statusColors = {
            'behandlung in uhs': '#a7c7e7',
            'verlegt in uhs': '#a7c7e7',
            'gemeldet': '#f28b82',
            'disponiert': '#fff475',
            'behandlung': '#81c995',
            'transport': '#d3d3d3',
            'entlassen': '#d3d3d3'
        };

        function loadPatientData() {
            try {
                const data = localStorage.getItem('patients');
                return data ? JSON.parse(data) : [];
            } catch (error) {
                console.error('Fehler beim Laden der Patientendaten:', error);
                return [];
            }
        }

        function parseStatusFromHistory(history) {
            const statusEvents = [];
            if (!history || !Array.isArray(history)) return statusEvents;

            history.forEach(entry => {
                const timeMatch = entry.match(/^(\d{2}:\d{2})/);
                const statusMatch = entry.match(/Status:\s*(.+)$/);
                
                if (timeMatch && statusMatch) {
                    const timeStr = timeMatch[1];
                    const [hours, minutes] = timeStr.split(':').map(Number);
                    const timeInMinutes = hours * 60 + minutes;
                    
                    statusEvents.push({
                        time: timeStr,
                        timeInMinutes,
                        status: statusMatch[1].toLowerCase()
                    });
                }
            });

            return statusEvents.sort((a, b) => a.timeInMinutes - b.timeInMinutes);
        }

        function getStatusColor(status) {
            const normalizedStatus = status.toLowerCase();
            for (const [key, color] of Object.entries(statusColors)) {
                if (normalizedStatus.includes(key)) {
                    return color;
                }
            }
            return '#6c757d'; // Default gray
        }

        function isEndpointStatus(status) {
            return status && (
                status.toLowerCase().includes('entlassen') ||
                status.toLowerCase().includes('transport in kh')
            );
        }

        let currentZoom = 30; // Default: 30 minutes visible
        let timelineContainer = null;

        function updateZoomInfo(pixelsPerMinute) {
            const zoomInfo = document.getElementById('zoomInfo');
            const visibleMinutes = Math.round(900 / pixelsPerMinute); // 900px viewport width
            zoomInfo.textContent = `${visibleMinutes} Min sichtbar`;
        }

        function centerOnCurrentTime() {
            if (!timelineContainer) return;
            
            const now = new Date();
            const currentTimeInMinutes = now.getHours() * 60 + now.getMinutes();
            
            // Get minTime from the last timeline calculation
            const patients = loadPatientData();
            let minTime = Infinity;
            
            patients.forEach(patient => {
                const statusEvents = parseStatusFromHistory(patient.history);
                statusEvents.forEach(event => {
                    minTime = Math.min(minTime, event.timeInMinutes);
                });
            });
            
            if (minTime === Infinity) return;
            
            const pixelsPerMinute = currentZoom;
            const currentTimePosition = (currentTimeInMinutes - minTime) * pixelsPerMinute;
            const scrollPosition = Math.max(0, currentTimePosition - 450); // Center in viewport
            
            timelineContainer.scrollLeft = scrollPosition;
        }

        function createComparativeTimeline(patients) {
            const container = document.getElementById('comparativeTimeline');
            container.innerHTML = '';

            if (patients.length === 0) {
                const noData = document.createElement('div');
                noData.className = 'no-data';
                noData.textContent = 'Keine Patientendaten im Local Storage gefunden.';
                container.appendChild(noData);
                return;
            }

            // Calculate time range including current time
            let minTime = Infinity;
            let maxTime = -Infinity;
            
            // Get current time in minutes
            const now = new Date();
            const currentTimeInMinutes = now.getHours() * 60 + now.getMinutes();
            
            const patientData = patients.map(patient => {
                const statusEvents = parseStatusFromHistory(patient.history);
                statusEvents.forEach(event => {
                    minTime = Math.min(minTime, event.timeInMinutes);
                    maxTime = Math.max(maxTime, event.timeInMinutes);
                });
                return { patient, statusEvents };
            });

            if (minTime === Infinity) return;

            // Extend maxTime to current time
            maxTime = Math.max(maxTime, currentTimeInMinutes);

            const timeRange = maxTime - minTime;
            
            // Use current zoom level
            const pixelsPerMinute = currentZoom;
            const timelineWidth = timeRange * pixelsPerMinute;

            // Create timeline container with scrolling
            const timeline = document.createElement('div');
            timeline.className = 'comparative-timeline';
            timelineContainer = timeline; // Store reference for centering

            // Create content container
            const timelineContent = document.createElement('div');
            timelineContent.className = 'timeline-content';
            timelineContent.style.width = (timelineWidth + 140) + 'px'; // Add space for labels

            // Create time axis
            const timeAxis = document.createElement('div');
            timeAxis.className = 'time-axis';
            timeAxis.style.marginLeft = '140px';
            timeAxis.style.width = timelineWidth + 'px';

            // Add time markers every 5 minutes for better granularity
            const timeStep = 5; // 5 minute intervals
            for (let t = Math.floor(minTime / timeStep) * timeStep; t <= maxTime; t += timeStep) {
                const hours = Math.floor(t / 60);
                const minutes = t % 60;
                const timeStr = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                
                const marker = document.createElement('div');
                marker.className = 'time-marker';
                marker.textContent = timeStr;
                marker.style.left = ((t - minTime) * pixelsPerMinute) + 'px';
                
                const gridLine = document.createElement('div');
                gridLine.className = 'time-grid-line';
                gridLine.style.left = ((t - minTime) * pixelsPerMinute) + 'px';
                
                timeAxis.appendChild(marker);
                timeAxis.appendChild(gridLine);
            }

            // Add current time marker
            const currentTimePosition = (currentTimeInMinutes - minTime) * pixelsPerMinute;
            const currentTimeMarker = document.createElement('div');
            currentTimeMarker.className = 'time-marker';
            currentTimeMarker.style.left = currentTimePosition + 'px';
            currentTimeMarker.style.color = '#dc3545';
            currentTimeMarker.style.fontWeight = 'bold';
            currentTimeMarker.textContent = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')} (Jetzt)`;
            
            const currentTimeLine = document.createElement('div');
            currentTimeLine.className = 'time-grid-line';
            currentTimeLine.style.left = currentTimePosition + 'px';
            currentTimeLine.style.backgroundColor = '#dc3545';
            currentTimeLine.style.width = '2px';
            
            timeAxis.appendChild(currentTimeMarker);
            timeAxis.appendChild(currentTimeLine);

            timelineContent.appendChild(timeAxis);

            // Create patient rows
            patientData.forEach(({ patient, statusEvents }) => {
                if (statusEvents.length === 0) return;

                const row = document.createElement('div');
                row.className = 'patient-row';

                const label = document.createElement('div');
                label.className = 'patient-label';
                label.textContent = `Patient ${patient.id}`;

                const patientTimeline = document.createElement('div');
                patientTimeline.className = 'patient-timeline';
                patientTimeline.style.width = timelineWidth + 'px';

                // Create status points and lines
                statusEvents.forEach((event, index) => {
                    const position = (event.timeInMinutes - minTime) * pixelsPerMinute;
                    
                    // Status point
                    const point = document.createElement('div');
                    point.className = 'status-point';
                    point.style.left = position + 'px';
                    point.style.backgroundColor = getStatusColor(event.status);
                    point.style.borderColor = getStatusColor(event.status);

                    // Tooltip
                    const tooltip = document.createElement('div');
                    tooltip.className = 'status-tooltip';
                    tooltip.textContent = `${event.time}: ${event.status}`;
                    point.appendChild(tooltip);

                    patientTimeline.appendChild(point);

                    // Check if this is an endpoint status
                    const isCurrentEndpoint = isEndpointStatus(event.status);

                    // Status line to next point or to current time (but not if current status is endpoint)
                    let nextPosition;
                    if (index < statusEvents.length - 1) {
                        nextPosition = (statusEvents[index + 1].timeInMinutes - minTime) * pixelsPerMinute;
                    } else if (!isCurrentEndpoint) {
                        // Last status extends to current time only if it's not an endpoint
                        nextPosition = (currentTimeInMinutes - minTime) * pixelsPerMinute;
                    }
                    
                    // Only create line if we have a next position (i.e., not an endpoint)
                    if (nextPosition !== undefined) {
                        const line = document.createElement('div');
                        line.className = 'status-line';
                        line.style.left = position + 'px';
                        line.style.width = (nextPosition - position) + 'px';
                        line.style.backgroundColor = getStatusColor(event.status);
                        
                        // Make the line to current time slightly transparent (only for non-endpoints)
                        if (index === statusEvents.length - 1 && !isCurrentEndpoint) {
                            line.style.opacity = '0.7';
                        }
                        
                        patientTimeline.appendChild(line);
                    }
                });

                row.appendChild(label);
                row.appendChild(patientTimeline);
                timelineContent.appendChild(row);
            });

            timeline.appendChild(timelineContent);
            container.appendChild(timeline);

            // Update zoom info
            updateZoomInfo(pixelsPerMinute);

            // Auto-scroll to show current time centered
            setTimeout(() => {
                centerOnCurrentTime();
            }, 100);
        }

        function createLegend() {
            const legend = document.getElementById('legend');
            legend.innerHTML = '';

            Object.entries(statusColors).forEach(([status, color]) => {
                const item = document.createElement('div');
                item.className = 'legend-item';

                const dot = document.createElement('div');
                dot.className = 'legend-dot';
                dot.style.backgroundColor = color;
                dot.style.borderColor = color;

                const text = document.createElement('span');
                text.textContent = status.charAt(0).toUpperCase() + status.slice(1);

                item.appendChild(dot);
                item.appendChild(text);
                legend.appendChild(item);
            });
        }

        function createLocationStatistics(patients) {
            const locationStats = {};
            let totalPatients = 0;
            
            patients.forEach(patient => {
                const location = patient.location || 'Unbekannt';
                locationStats[location] = (locationStats[location] || 0) + 1;
                totalPatients++;
            });
            
            const container = document.getElementById('locationStats');
            container.innerHTML = '';
            
            if (totalPatients === 0) {
                container.innerHTML = '<div class="no-data">Keine Daten verfügbar</div>';
                return;
            }
            
            // Sort by count (descending)
            const sortedLocations = Object.entries(locationStats)
                .sort(([,a], [,b]) => b - a);
            
            sortedLocations.forEach(([location, count]) => {
                const percentage = ((count / totalPatients) * 100).toFixed(1);
                
                const item = document.createElement('div');
                item.className = 'stat-item';
                
                item.innerHTML = `
                    <span class="stat-label">${location}</span>
                    <div style="display: flex; align-items: center;">
                        <span class="stat-value">${count}</span>
                        <div class="stat-bar">
                            <div class="stat-bar-fill" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
                
                container.appendChild(item);
            });
        }
        
        function createDiagnosisStatistics(patients) {
            const diagnosisStats = {};
            let totalPatients = 0;
            
            patients.forEach(patient => {
                const diagnosis = patient.diagnosis || 'Keine Diagnose';
                diagnosisStats[diagnosis] = (diagnosisStats[diagnosis] || 0) + 1;
                totalPatients++;
            });
            
            const container = document.getElementById('diagnosisStats');
            container.innerHTML = '';
            
            if (totalPatients === 0) {
                container.innerHTML = '<div class="no-data">Keine Daten verfügbar</div>';
                return;
            }
            
            // Sort by count (descending)
            const sortedDiagnoses = Object.entries(diagnosisStats)
                .sort(([,a], [,b]) => b - a);
            
            sortedDiagnoses.forEach(([diagnosis, count]) => {
                const percentage = ((count / totalPatients) * 100).toFixed(1);
                
                const item = document.createElement('div');
                item.className = 'stat-item';
                
                item.innerHTML = `
                    <span class="stat-label">${diagnosis}</span>
                    <div style="display: flex; align-items: center;">
                        <span class="stat-value">${count}</span>
                        <div class="stat-bar">
                            <div class="stat-bar-fill" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
                
                container.appendChild(item);
            });
        }

        function renderTimelines() {
            const patients = loadPatientData();
            createLegend();
            createComparativeTimeline(patients);
            createLocationStatistics(patients);
            createDiagnosisStatistics(patients);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Zoom slider
            const zoomSlider = document.getElementById('zoomSlider');
            zoomSlider.addEventListener('input', (e) => {
                currentZoom = parseInt(e.target.value);
                renderTimelines();
            });

            // Reset zoom button
            document.getElementById('resetZoom').addEventListener('click', () => {
                currentZoom = 30;
                zoomSlider.value = 30;
                renderTimelines();
            });

            // Center on current time button
            document.getElementById('centerCurrent').addEventListener('click', () => {
                centerOnCurrentTime();
            });

            // Initial render
            renderTimelines();
        });

        // Refresh data every 30 seconds
        setInterval(renderTimelines, 30000);
    </script>
</body>
</html>
