<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Truppüberwachung</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
      /* —— Patienten-Tracker Button Styles —— */
      button {
        padding: 8px 14px;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: background-color 0.2s ease-in-out;
      }
      button:hover {
        background-color: #005f73;
      }

      /* Spezifische Status-Buttons (falls Du sie nutzt) */
      button.status-gemeldet {
        background-color: #f28b82;
        color: white;
      }
      button.status-disponiert {
        background-color: #fff475;
        color: black;
      }
      button.status-in-Behandlung {
        background-color: #81c995;
        color: white;
      }
      button.status-verlegt-in-UHS,
      button.status-Behandlung-in-UHS {
        background-color: #a7c7e7;
        color: black;
      }
      button.status-Transport-in-KH,
      button.status-Entlassen {
        background-color: #d3d3d3;
        color: black;
      }

      /* —— Ende Patienten-Tracker Button Styles —— */
      .max-einsatz-time {
        display: none !important;
      }
      .trupp.einsatz-beendet {
        border-left: 5px solid rebeccapurple;
        background-color: #ffffff;
      }

      body {
        font-family: sans-serif;
        padding: 20px;
        background: #ffffff;
      }
      input[type="text"] {
        margin: 3px 5px 3px 0;
        padding: 6px;
        font-size: 0.9rem;
        width: 100%;
        border-radius: 5px;
        border: 1px solid #ccc;
        box-sizing: border-box;
      }
      button {
        padding: 6px 10px;
        font-size: 0.8rem;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin: 2px;
        flex-shrink: 0;
      }
      .reset-btn {
        background-color: #dc3545;
        color: white;
      }
      .export-btn {
        background-color: #007bff;
        color: white;
      }
      .section {
        margin-top: 40px;
      }
      .section h2 {
        border-bottom: 2px solid #ccc;
        padding-bottom: 5px;
        color: #444;
      }
      .section div {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px;
      }
      .trupp {
        border: 2px solid #ccc;
        padding: 10px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        background: #fff;
        transition: transform 0.4s ease, opacity 0.4s ease;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .trupp.move-out {
        transform: scale(0.9) translateX(100px);
        opacity: 0;
      }
      .trupp.move-in,
      .trupp.move-in-active {
        transform: none !important;
        opacity: 1 !important;
        transition: none !important;
      }
      .einsatz {
        border-left: 5px solid #28a745;
        background: #d4edda;
      }
      .pause {
        border-left: 5px solid #007bff;
        background: #d6eaff;
      }
      .nicht-einsatzbereit {
        border-left: 5px solid #6c757d;
        background: #e2e3e5;
      }
      .ueberzogen {
        border: 2px solid red;
      }
      .rueckhaltung {
        border: 2px solid gold;
        background-color: #fff9e6;
        opacity: 0.6;
      }
      .patient {
        border: 2px solid red;
        background-color: #ff9999;
      }
      .spielfeldrand {
        border: 2px solid orange;
        background-color: #ffe8cc;
      }
      .trupp-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 10px;
        border-bottom: 2px solid #ccc;
        font-size: 1.2rem;
        font-weight: bold;
        color: #333;
        background-color: #ffffff;
        border-radius: 8px 8px 0 0;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .trupp input[type="text"] {
        margin-top: 5px;
        width: 100%;
      }
      .meldung-btn {
        background-color: #e6f0ff;
        border: 1px solid #3399ff;
        color: #003366;
        padding: 4px 10px;
        font-size: 0.8rem;
        border-radius: 5px;
        cursor: pointer;
      }
      .btn-nicht-einsatzbereit {
        background-color: #6c757d;
        color: white;
      }
      .btn-pause {
        background-color: #007bff;
        color: white;
      }
      .btn-einsatz {
        background-color: #28a745;
        color: white;
      }
      .btn-patient {
        background-color: #ffc107;
        color: black;
      }
      .btn-spielfeldrand {
        background-color: #fd7e14;
        color: white;
      }
      body.darkmode {
        background-color: #121212;
        color: #000;
      }

      .delete-btn {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 2px 4px;
        font-size: 0.7rem;
        border-radius: 3px;
        cursor: pointer;
        align-self: flex-end;
        width: 20px;
        height: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .status-buttons {
        display: none;
        margin-top: 5px;
        flex-direction: column;
        gap: 4px;
      }
      .trupp.show-status-buttons .status-buttons {
        display: flex;
      }
      .status-display {
        cursor: pointer;
        padding: 6px;
        border-radius: 5px;
        font-weight: bold;
        font-size: 1.1rem;
        background-color: #ffffff;
        border: 1px solid #ccc;
      }
      .trupp.show-status-buttons .status-display {
        background: #007bff;
        color: white;
        border-color: #0056b3;
      }
      .max-einsatz-time {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 16px 0;
        padding: 8px 12px;
        background: #f5f7fa;
        border: 1px solid #d1d9e6;
        border-radius: 6px;
        max-width: 300px;
      }

      .max-einsatz-time label {
        font-weight: 600;
        color: #333;
        white-space: nowrap;
      }

      .max-einsatz-time input {
        flex-shrink: 0;
        width: 60px;
        padding: 6px 10px;
        font-size: 1rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        transition: border-color 0.2s, box-shadow 0.2s;
      }

      .max-einsatz-time input:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
      }
    </style>
  </head>
  <body>
    <div class="max-einsatz-time">
      <label for="maxEinsatzTime">Maximale Einsatzzeit (Min.)</label>
      <input
        type="number"
        id="maxEinsatzTime"
        onchange="updateMaxEinsatzTime()"
      />
    </div>

    <input type="text" id="newTruppName" placeholder="Neuer Truppname" />
    <button onclick="addTrupp()">Trupp hinzufügen</button>
    <button onclick="addSKTrupps()">Stadion 10-60 hinzufügen</button>
    <button onclick="addKLTrupps()">Kiellinie 1-10 hinzufügen</button>
    <button onclick="addOKTrupps()">Ostseekai 1-10 hinzufügen</button>
    <button onclick="addISTrupps()">Innenstadt 1-10 hinzufügen</button>
    <button onclick="addBHTrupps()">Bahnhof 1-10 hinzufügen</button>

    <div class="section">
      <h2>Im Einsatz</h2>
      <div id="einsatzContainer"></div>
    </div>
    <div class="section">
      <h2>In Pause</h2>
      <div id="pauseContainer"></div>
    </div>
    <div class="section">
      <h2>Nicht Einsatzbereit</h2>
      <div id="nichtContainer"></div>
    </div>

    <script>
      // === 1) nextPatientNumber purely in JS, kein Input ===
      let nextPatientNumber =
        parseInt(localStorage.getItem("nextPatientNumber"), 10) || 1;

      // === 2) Polling-Fallback (gleicher iframe) ===
      setInterval(() => {
        const v = parseInt(localStorage.getItem("nextPatientNumber"), 10) || 1;
        if (v !== nextPatientNumber) {
          nextPatientNumber = v;
        }
      }, 2000);

      // === 3) storage-Event (andere iframes/tabs) ===
      window.addEventListener("storage", (e) => {
        if (e.key === "nextPatientNumber") {
          nextPatientNumber = parseInt(e.newValue, 10) || 1;
        }
      });

      // === 4) updateTrupp: wenn Status Patient, nextPatientNumber verwenden ===
      function updateTrupp(index, status) {
        // 0) Scroll-Position merken
        const scrollEl = document.scrollingElement || document.documentElement;
        const scrollY = scrollEl.scrollTop;

        const trupp = trupps[index];
        const oldStatus = trupp.status;
        const now = Date.now();
        const timeStr = new Date(now).toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });

        // 1) Status-Gruppen definieren
        const einsatzStatuses = [
          "Streife",
          "Patient",
          "Spielfeldrand",
          "Einsatz beendet",
        ];
        const pauseStatuses = [
          "Einsatzbereit in UHS",
          "Einsatzbereit unterwegs",
          "Einsatzbereit in Rückhaltung",
        ];
        // Alles andere ist "Nicht Einsatzbereit"

        // 2) Wechsel IN Pausen-Status → Pause neu starten
        if (
          pauseStatuses.includes(status) &&
          !pauseStatuses.includes(oldStatus)
        ) {
          trupp.pausenzeit = 0;
          trupp.currentPauseStart = now;
        }

        // 3) Wechsel WEG von Pausen-Status → Messung stoppen
        if (
          !pauseStatuses.includes(status) &&
          pauseStatuses.includes(oldStatus)
        ) {
          trupp.currentPauseStart = null;
        }

        // 4) Wechsel IN Einsatz-Status → Einsatz neu starten
        if (
          einsatzStatuses.includes(status) &&
          !einsatzStatuses.includes(oldStatus)
        ) {
          trupp.einsatzzeit = 0;
          trupp.currentEinsatzStart = now;
        }

        // 5) Wechsel WEG von Einsatz-Status → Messung stoppen
        if (
          !einsatzStatuses.includes(status) &&
          einsatzStatuses.includes(oldStatus)
        ) {
          trupp.currentEinsatzStart = null;
        }

        // 6) Historie-Eintrag
        if (!trupp.history) trupp.history = [];
        if (oldStatus !== status) {
          trupp.history.push(`${timeStr} Status: ${status}`);
        }

        // 7) Spezielle Abschlüsse für Patient & Streife
        if (
          oldStatus === "Patient" &&
          trupp.patientInput &&
          trupp.patientStart
        ) {
          trupp.patientHistorie.push({
            nummer: trupp.patientInput,
            von: trupp.patientStart,
            bis: now,
          });
          trupp.patientInput = trupp.patientStart = null;
        }
        if (
          oldStatus === "Streife" &&
          trupp.currentOrt &&
          trupp.einsatzStartOrt
        ) {
          trupp.einsatzHistorie.push({
            ort: trupp.currentOrt,
            von: trupp.einsatzStartOrt,
            bis: now,
          });
          trupp.currentOrt = trupp.einsatzStartOrt = null;
        }

        // 8) Wechsel auf Patient → neuen Patienten anlegen
        if (oldStatus !== "Patient" && status === "Patient") {
          trupp.patientInput = nextPatientNumber;

          const createdMs = Date.now();
          const timeStr = new Date(createdMs).toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
          });

          const patients = JSON.parse(localStorage.getItem("patients")) || [];
          const neueId = trupp.patientInput;
          const letzteOrt =
            trupp.currentOrt ||
            (trupp.einsatzHistorie.length
              ? trupp.einsatzHistorie.at(-1).ort
              : "");

          const newPatient = {
            id: neueId,
            createdAt: createdMs,
            status: "disponiert",
            age: "",
            gender: "M",
            diagnosis: "",
            location: letzteOrt,
            team: [trupp.name],
            rtm: "",
            discharge: "",
            additionalRequest: "",
            history: [
              `${timeStr} Status: gemeldet`,
              `${timeStr} Status: disponiert`,
              `${timeStr} Trupp ${trupp.name} disponiert`,
            ],
            statusTimestamps: {
              gemeldet: createdMs,
              disponiert: createdMs,
            },
            durations: {
              einsatzdauer: "", // bleibt noch live
              dispositionsdauer: "00:00", // sofort fixiert
              ausrueckdauer: "",
              behandlungsdauer: "", // <<< jetzt auch initialisiert
              verlegedauerUHS: "",
            },
          };

          // 1) Patient anlegen
          patients.push(newPatient);
          localStorage.setItem("patients", JSON.stringify(patients));
          // 2) storage-Event feuern
          window.dispatchEvent(
            new StorageEvent("storage", {
              key: "patients",
              newValue: JSON.stringify(patients),
            })
          );

          // 3) Next-ID schieben
          nextPatientNumber++;
          localStorage.setItem("nextPatientNumber", String(nextPatientNumber));

          // 4) Trupp-Start zurücksetzen
          trupp.patientStart = Date.now();
        }

        // 9) Bei Streife → neuen Ort abfragen
        if (status === "Streife") {
          trupp.einsatzStartOrt = now;
          const neuerOrt = prompt(
            "Bitte Einsatzort eingeben:",
            trupp.currentOrt || ""
          );
          if (neuerOrt !== null) trupp.currentOrt = neuerOrt.trim();
        }

        // 10) Status übernehmen
        trupp.status = status;
        trupp.lastStatusChange = now;

        // 11) Trupp aus Patientendaten entfernen, wenn Weg von Patient
        if (oldStatus === "Patient" && status !== "Patient") {
          const patients = JSON.parse(localStorage.getItem("patients")) || [];
          patients.forEach((p) => {
            if (Array.isArray(p.team)) {
              const idx = p.team.indexOf(trupp.name);
              if (idx >= 0) {
                p.team.splice(idx, 1);
                p.history = p.history || [];
                p.history.push(`${timeStr} Trupp ${trupp.name} entfernt`);
              }
            }
          });
          localStorage.setItem("patients", JSON.stringify(patients));
          window.dispatchEvent(
            new StorageEvent("storage", {
              key: "patients",
              newValue: JSON.stringify(patients),
            })
          );
        }

        // 12) Speichern & neu rendern
        saveTrupps();
        renderTrupps();
        window.scrollTo(0, scrollY);
      }

      const jsPDF = window.jspdf.jsPDF;
      function updateMaxEinsatzTime() {
        localStorage.setItem("nextMaxEinsatzTime", nextMaxEinsatzTime);
        renderTrupps();
      }

      function toggleStatusButtons(truppId) {
        const truppDivs = document.querySelectorAll(".trupp");

        truppDivs.forEach((div) => {
          const buttons = div.querySelector(".status-buttons");

          if (div.dataset.truppId === truppId) {
            const isVisible = buttons.style.display === "flex";
            buttons.style.display = isVisible ? "none" : "flex";

            if (!isVisible) {
              div.classList.add("show-status-buttons");
            } else {
              div.classList.remove("show-status-buttons");
            }
          } else {
            buttons.style.display = "none";
            div.classList.remove("show-status-buttons");
          }
        });
      }

      function toggleDarkmode() {
        document.body.classList.toggle("darkmode");
        document
          .querySelectorAll(".trupp")
          .forEach((el) => el.classList.toggle("darkmode"));
        document
          .querySelectorAll("button")
          .forEach((el) => el.classList.toggle("darkmode"));
        document
          .querySelectorAll("input")
          .forEach((el) => el.classList.toggle("darkmode"));
        localStorage.setItem(
          "darkmode",
          document.body.classList.contains("darkmode")
        );
      }
      function copyToClipboard(truppName) {
        const trupp = trupps.find((t) => t.name === truppName);
        if (!trupp) return;

        let meldung = "";

        switch (trupp.status) {
          case "Einsatzbereit in UHS":
            meldung = `${trupp.name} einsatzbereit in UHS`;
            break;
          case "Nicht Einsatzbereit":
            meldung = `${trupp.name} nicht einsatzbereit`;
            break;
          case "Streife":
            meldung = `${trupp.name} übernimmt Streifengebiet ${
              trupp.currentOrt || "[Ort]"
            }`;
            break;
          case "Patient":
            const standort =
              trupp.currentOrt ||
              (trupp.einsatzHistorie.length
                ? trupp.einsatzHistorie[trupp.einsatzHistorie.length - 1].ort
                : "");
            meldung = `Patient Nr.: ${trupp.patientInput || "[Patientennummer]"}
Trupp: ${trupp.name}
Standort: ${standort || ""}
Alter:
Geschlecht:
Verdachtsdiagnose:
Nachforderung:
Bemerkung:`;
            break;
          case "Spielfeldrand":
            const alle = trupps
              .filter((t) => t.status === "Spielfeldrand")
              .map((t) => t.name)
              .join(", ");
            meldung = `${alle} Spielfeldrand erreicht`;
            break;
          default:
            meldung = `${trupp.name}: ${trupp.status}`;
        }

        navigator.clipboard
          .writeText(meldung)
          .then(() => {
            console.log("In Zwischenablage kopiert:", meldung);
          })
          .catch((err) => {
            console.error("Fehler beim Kopieren:", err);
          });
      }

      function formatTime(ms) {
        const d = new Date(ms);
        return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
      }

      let trupps = JSON.parse(localStorage.getItem("trupps") || "[]");

      window.addEventListener("storage", (e) => {
        if (e.key === "trupps") {
          trupps = JSON.parse(e.newValue || "[]");
          renderTrupps();
        }
      });

      window.addEventListener("storage", (e) => {
        if (e.key === "nextMaxEinsatzTime") {
          // Wert aus localStorage holen und in die Variable schieben
          nextMaxEinsatzTime = parseInt(e.newValue, 10) || 45;
          // Tracker neu zeichnen
          renderTrupps();
        }
      });

      let nextMaxEinsatzTime =
        parseInt(localStorage.getItem("nextMaxEinsatzTime"), 10) || 45;
      document.getElementById("maxEinsatzTime").value = nextMaxEinsatzTime;

      // Helper, um einen Statuswechsel intern zu initialisieren
      function handleRemoteStatusChanges(oldList, newList) {
        newList.forEach((tNew) => {
          const tOld = oldList.find((t) => t.name === tNew.name);
          if (tOld && tOld.status !== tNew.status) {
            // wenn wir jetzt in einen Einsatz‐Status wechseln, setze Einsatzstart
            if (["Streife", "Patient", "Spielfeldrand"].includes(tNew.status)) {
              tNew.currentEinsatzStart = Date.now();
              tNew.einsatzStartOrt = tNew.currentOrt;
              // und lösche ggf. laufende Pause‐Werte
              tNew.currentPauseStart = null;
            }
            // sonst, wenn wir in Pause zurückfallen, setze Pause‐Start
            else if (
              [
                "Einsatzbereit in UHS",
                "Einsatzbereit unterwegs",
                "Einsatzbereit in Rückhaltung",
              ].includes(tNew.status)
            ) {
              tNew.currentPauseStart = Date.now();
            }
          }
        });
      }

      // storage‐Event
      window.addEventListener("storage", (e) => {
        if (e.key === "trupps") {
          const latest = JSON.parse(e.newValue || "[]");
          handleRemoteStatusChanges(trupps, latest);
          trupps = latest;
          renderTrupps();
        }
      });

      // Fallback alle 5 s
      setInterval(() => {
        const latest = JSON.parse(localStorage.getItem("trupps") || "[]");
        if (JSON.stringify(latest) !== JSON.stringify(trupps)) {
          handleRemoteStatusChanges(trupps, latest);
          trupps = latest;
          renderTrupps();
        }
      }, 5000);

      function saveTrupps() {
        localStorage.setItem("nextPatientNumber", nextPatientNumber);
        localStorage.setItem("nextMaxEinsatzTime", nextMaxEinsatzTime);
        localStorage.setItem("nextPatientNumber", nextPatientNumber);
        localStorage.setItem("trupps", JSON.stringify(trupps));
      }

      function resetAll() {
        if (confirm("Willst du wirklich alle Daten löschen?")) {
          // Entferne alle relevanten LocalStorage-Einträge
          localStorage.removeItem("trupps");
          localStorage.removeItem("nextPatientNumber");
          localStorage.removeItem("nextMaxEinsatzTime");

          // Setze Arrays/Variablen zurück
          trupps = [];
          nextPatientNumber = 1;
          nextMaxEinsatzTime = 45;

          // Aktualisiere die Eingabefelder
          document.getElementById("maxEinsatzTime").value = nextMaxEinsatzTime;

          // Speichere und rendere neu
          saveTrupps();
          renderTrupps();
        }
      }

      function addTrupp(name = null) {
        const input =
          name || document.getElementById("newTruppName").value.trim();
        if (!input) return;
        trupps.push({
          name: input,
          status: "Nicht Einsatzbereit",
          lastStatusChange: Date.now(),
          currentPauseStart: Date.now(),
          currentEinsatzStart: null,
          totalPauseTime: 0,
          pausenzeit: 0, // neu: initiale Pausenzeit
          einsatzzeit: 0, // neu: initiale Einsatzzeit
          einsatzHistorie: [],
          patientHistorie: [],
          patientInput: "",
          currentOrt: "",
          einsatzStartOrt: null,
          patientStart: null,
        });
        // Eingabefeld leeren, wenn vom Nutzer getriggert
        if (!name) document.getElementById("newTruppName").value = "";
        saveTrupps();
        renderTrupps();
      }

      function addSKTrupps() {
        for (let i = 10; i <= 60; i += 5) addTrupp(`Stadion ${i}`);
      }

      function addKLTrupps() {
        for (let i = 1; i <= 10; i += 1) addTrupp(`Kiellinie ${i}`);
      }

      function addOKTrupps() {
        for (let i = 1; i <= 10; i += 1) addTrupp(`Ostseekai ${i}`);
      }

      function addISTrupps() {
        for (let i = 1; i <= 10; i += 1) addTrupp(`Innenstadt ${i}`);
      }

      function addBHTrupps() {
        for (let i = 1; i <= 10; i += 1) addTrupp(`Bahnhof ${i}`);
      }

      function deleteTrupp(index) {
        if (!confirm("Willst du diesen Trupp wirklich löschen?")) return;
        const key = trupps[index].name;
        const el = document.querySelector(`[data-key="${key}"]`);
        if (el) {
          el.classList.add("move-out");
          setTimeout(() => {
            trupps.splice(index, 1);
            saveTrupps();
            renderTrupps();
          }, 300); // Delay matches CSS transition time
        } else {
          trupps.splice(index, 1);
          saveTrupps();
          renderTrupps();
        }
      }

      function renderTrupps() {
        const scrollY = window.scrollY;
        const now = Date.now();

        const prevRects = new Map();
        document.querySelectorAll(".trupp").forEach((el) => {
          if (el.dataset.key)
            prevRects.set(el.dataset.key, el.getBoundingClientRect());
        });

        einsatzContainer.innerHTML =
          pauseContainer.innerHTML =
          nichtContainer.innerHTML =
            "";
        const einsatz = [],
          pause = [],
          nicht = [];

        trupps.forEach((trupp, i) => {
          if (!trupp.id)
            trupp.id = "trupp_" + Math.random().toString(36).substring(2, 10);
          const div = document.createElement("div");
          div.className = "trupp";
          div.dataset.key = trupp.name;
          div.dataset.truppId = trupp.id;

          const einsatzzeit = trupp.einsatzzeit || 0;
          let pausenzeit = trupp.pausenzeit || 0;
          let totalPause = trupp.totalPauseTime || 0;

          if (
            trupp.currentEinsatzStart &&
            einsatzzeit > nextMaxEinsatzTime * 60000
          )
            div.classList.add("ueberzogen");
          if (trupp.status === "Einsatzbereit in Rückhaltung")
            div.classList.add("rueckhaltung");
          if (trupp.status === "Patient") div.classList.add("patient");
          if (trupp.status === "Spielfeldrand")
            div.classList.add("spielfeldrand");
          // 1) erst einmal die gemeinsame Einsatz-Gruppe
          if (
            ["Streife", "Patient", "Spielfeldrand", "Einsatz beendet"].includes(
              trupp.status
            )
          ) {
            div.classList.add("einsatz");
            // und wenn es genau "Einsatz beendet" ist, den lila Style
            if (trupp.status === "Einsatz beendet") {
              div.classList.add("einsatz-beendet");
            }
          }
          // 2) Pause-Status
          else if (
            [
              "Einsatzbereit in UHS",
              "Einsatzbereit unterwegs",
              "Einsatzbereit in Rückhaltung",
            ].includes(trupp.status)
          ) {
            div.classList.add("pause");
          }
          // 3) alle anderen → nicht einsatzbereit
          else {
            div.classList.add("nicht-einsatzbereit");
          }

          const min = (ms) => Math.floor(ms / 60000);
          const timeDisplay =
            trupp.currentEinsatzStart &&
            trupp.status !== "Einsatzbereit in Rückhaltung"
              ? `Aktuelle Einsatzzeit: ${min(einsatzzeit)} Min`
              : `Aktuelle Pausenzeit: ${min(pausenzeit)} Min${
                  trupp.status === "Einsatzbereit in Rückhaltung"
                    ? " (Rückhaltung zählt als Pause)"
                    : ""
                }`;

          const gesamtPause = `Gesamte Pausenzeit: ${min(totalPause)} Min`;

          const progress =
            trupp.currentEinsatzStart &&
            trupp.status !== "Einsatzbereit in Rückhaltung"
              ? Math.min(einsatzzeit / (nextMaxEinsatzTime * 60000), 1)
              : 0;
          const progressBar =
            trupp.currentEinsatzStart &&
            trupp.status !== "Einsatzbereit in Rückhaltung"
              ? `<div style='background:#ccc;height:8px;border-radius:4px;margin-top:4px;'>
     <div style='height:8px;width:${Math.floor(
       progress * 100
     )}%;background:#28a745;border-radius:4px;'></div>
   </div>`
              : "";

          div.innerHTML = `
          <div class="trupp-header">
  <h3>${trupp.name}</h3>
  ${
    trupp.status === "Nicht Einsatzbereit"
      ? `<button class="delete-btn" onclick="deleteTrupp(${i})">×</button>`
      : ""
  }
          </div>
          <div style="display: flex; align-items: center; gap: 8px;">
  <span class="status-display" onclick="toggleStatusButtons('${
    trupp.id
  }')">Status: ${trupp.status}</span>
  ${
    !["Einsatzbereit in Rückhaltung", "Einsatzbereit unterwegs"].includes(
      trupp.status
    )
      ? `<button class="meldung-btn" onclick="copyToClipboard('${trupp.name}')">Meldung</button>`
      : ""
  }
</div>
<div class="status-buttons" style="display:none;">
<button class="btn-nicht-einsatzbereit" onclick="updateTrupp(${i}, 'Nicht Einsatzbereit')">Nicht Einsatzbereit</button>
            <button class="btn-pause" onclick="updateTrupp(${i}, 'Einsatzbereit in UHS')">In UHS</button>
            <button class="btn-pause" onclick="updateTrupp(${i}, 'Einsatzbereit unterwegs')">Unterwegs</button>
            <button class="btn-pause" onclick="updateTrupp(${i}, 'Einsatzbereit in Rückhaltung')">In Rückhaltung</button>
            <button class="btn-einsatz" onclick="updateTrupp(${i}, 'Streife')">Streife</button>
            ${
              trupp.status !== "Patient"
                ? `<button class="btn-patient" onclick="updateTrupp(${i}, 'Patient')">Patient</button>`
                : ""
            }
            <button class="btn-spielfeldrand" onclick="updateTrupp(${i}, 'Spielfeldrand')">Spielfeldrand</button>
          </div>

		  ${
        trupp.status === "Streife"
          ? `<p><strong>${
              trupp.currentOrt || "kein Einsatzort"
            }</strong> <button onclick="editOrt(${i})">✎</button></p>`
          : ""
      }
          ${
            trupp.status === "Patient"
              ? `<p><strong>Patient ${
                  trupp.patientInput || "keine Nummer"
                }</strong> <button onclick="editPatient(${i})">✎</button></p>`
              : ""
          }

          <p>${timeDisplay}</p>
          ${progressBar}
          <p>${gesamtPause}</p>

          <p><strong>Einsatzorte:</strong><br>
            ${
              trupp.einsatzHistorie.length
                ? trupp.einsatzHistorie
                    .map(
                      (h) =>
                        `${h.ort} (${formatTime(h.von)} - ${formatTime(h.bis)})`
                    )
                    .join("<br>")
                : "–"
            }
          </p>
          <p><strong>Patientennummern:</strong><br>
            ${
              trupp.patientHistorie.length
                ? trupp.patientHistorie
                    .map(
                      (h) =>
                        `${h.nummer} (${formatTime(h.von)} - ${formatTime(
                          h.bis
                        )})`
                    )
                    .join("<br>")
                : "–"
            }
          </p>
        `;

          const einsatzSort =
            trupp.status === "Spielfeldrand"
              ? 99
              : trupp.status === "Patient"
              ? 2
              : trupp.status === "Einsatz beendet"
              ? 1
              : 0;
          if (
            ["Streife", "Patient", "Spielfeldrand", "Einsatz beendet"].includes(
              trupp.status
            )
          )
            einsatz.push({ el: div, sort: einsatzSort });
          else if (
            ["Einsatzbereit in UHS", "Einsatzbereit unterwegs"].includes(
              trupp.status
            )
          )
            pause.push({ el: div, sort: pausenzeit });
          else if (trupp.status === "Einsatzbereit in Rückhaltung")
            pause.push({ el: div, sort: -1 });
          else nicht.push({ el: div, sort: pausenzeit });
        });

        // 1) Im Einsatz: sortiere absteigend nach aktueller Einsatzzeit
        // --- am Ende von renderTrupps(), statt deiner jetzigen drei .sort-Blöcke ---

        // 1) IM EINSATZ: erst nach Status-Priorität (sort), dann nach Einsatzzeit absteigend
        einsatz
          .sort((a, b) => {
            if (a.sort !== b.sort) return a.sort - b.sort;
            const tA =
              trupps.find((t) => t.name === a.el.dataset.key).einsatzzeit || 0;
            const tB =
              trupps.find((t) => t.name === b.el.dataset.key).einsatzzeit || 0;
            return tB - tA; // längste Einsatzzeit zuerst
          })
          .forEach((t) => einsatzContainer.appendChild(t.el));

        // 2) IN PAUSE: erst nach Pausen-Priorität (hier pausenstatus, wir haben kein sort dafür,
        //    also überspringen wir stattdessen direkt die Zeit-Sortierung)
        pause
          .sort((a, b) => {
            const statusOrder = [
              "Einsatzbereit in UHS",
              "Einsatzbereit unterwegs",
              "Einsatzbereit in Rückhaltung",
            ];
            const trA = trupps.find((t) => t.name === a.el.dataset.key);
            const trB = trupps.find((t) => t.name === b.el.dataset.key);
            const ordA = statusOrder.indexOf(trA.status);
            const ordB = statusOrder.indexOf(trB.status);
            if (ordA !== ordB) return ordA - ordB;
            // gleiche Gruppe → längste Pausenzeit zuerst
            return (trB.pausenzeit || 0) - (trA.pausenzeit || 0);
          })
          .forEach((t) => pauseContainer.appendChild(t.el));

        // 3) NICHT EINSATZBEREIT: weiter unverändert, nach Pausenzeit
        nicht
          .sort((a, b) => {
            const pA =
              trupps.find((t) => t.name === a.el.dataset.key).pausenzeit || 0;
            const pB =
              trupps.find((t) => t.name === b.el.dataset.key).pausenzeit || 0;
            return pB - pA;
          })
          .forEach((t) => nichtContainer.appendChild(t.el));

        window.scrollTo(0, scrollY);

        requestAnimationFrame(() => {
          document.querySelectorAll(".trupp").forEach((el) => {
            const key = el.dataset.key;
            const oldRect = prevRects.get(key);
            if (!oldRect) return;
            const newRect = el.getBoundingClientRect();
            const dx = oldRect.left - newRect.left;
            const dy = oldRect.top - newRect.top;
            if (dx !== 0 || dy !== 0) {
              el.style.transition = "none";
              el.style.transform = `translate(${dx}px, ${dy}px)`;
              requestAnimationFrame(() => {
                el.style.transition = "transform 0.4s ease";
                el.style.transform = "";
              });
            }
          });
        });
      }

      renderTrupps();
      setInterval(renderTrupps, 30000);

      setInterval(() => {
        const now = Date.now();

        trupps.forEach((trupp) => {
          // wenn wir in einer Pause sind
          if (
            [
              "Einsatzbereit in UHS",
              "Einsatzbereit unterwegs",
              "Einsatzbereit in Rückhaltung",
            ].includes(trupp.status)
          ) {
            if (trupp.currentPauseStart) {
              // Differenz vom letzten Start holen
              const diff = now - trupp.currentPauseStart;
              trupp.pausenzeit = (trupp.pausenzeit || 0) + diff;
              trupp.totalPauseTime += diff;
              // neuen Startzeitpunkt setzen
              trupp.currentPauseStart = now;
            }
          }
          // wenn wir im Einsatz sind (incl. "Einsatz beendet", falls du das weiterlaufen lassen möchtest)
          else if (
            ["Streife", "Patient", "Spielfeldrand", "Einsatz beendet"].includes(
              trupp.status
            )
          ) {
            if (trupp.currentEinsatzStart) {
              const diff = now - trupp.currentEinsatzStart;
              trupp.einsatzzeit = (trupp.einsatzzeit || 0) + diff;
              // neuen Startzeitpunkt setzen
              trupp.currentEinsatzStart = now;
            }
          }
        });

        saveTrupps();
        renderTrupps();
      }, 15000);

      async function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let y = 10;

        doc.setFontSize(14);
        doc.text("Truppübersicht", 10, y);
        y += 10;

        trupps.forEach((trupp) => {
          // Gesamte Pausenzeit direkt aus totalPauseTime (in ms) in Minuten umrechnen
          const totalPause = Math.floor((trupp.totalPauseTime || 0) / 60000);

          if (y > 240) {
            doc.addPage();
            y = 10;
          }

          doc.setFontSize(12);
          doc.text(`Trupp: ${trupp.name}`, 10, y);
          y += 6;
          doc.text(`Gesamte Pausenzeit: ${totalPause} Min`, 10, y);
          y += 6;

          const einsatzHistorie = trupp.einsatzHistorie.length
            ? trupp.einsatzHistorie.map(
                (e) =>
                  `• ${e.ort} (${formatTime(e.von)} - ${formatTime(e.bis)})`
              )
            : ["–"];
          doc.text("Einsatzorte:", 10, y);
          y += 6;
          einsatzHistorie.forEach((line) => {
            doc.text(line, 15, y);
            y += 6;
          });

          const patientHistorie = trupp.patientHistorie.length
            ? trupp.patientHistorie.map(
                (p) =>
                  `• ${p.nummer} (${formatTime(p.von)} - ${formatTime(p.bis)})`
              )
            : ["–"];
          doc.text("Patientennummern:", 10, y);
          y += 6;
          patientHistorie.forEach((line) => {
            doc.text(line, 15, y);
            y += 6;
          });

          y += 8;
          if (y > 270) {
            doc.addPage();
            y = 10;
          }
        });

        doc.save("trupp_status_report.pdf");
      }

      function editOrt(index) {
        const trupp = trupps[index];
        const newOrt = prompt(
          "Neuen Einsatzort eingeben:",
          trupp.currentOrt || ""
        );
        if (newOrt !== null) {
          trupp.currentOrt = newOrt.trim();
          saveTrupps();
          renderTrupps();
        }
      }

      function editPatient(index) {
        const trupp = trupps[index];
        const newPatient = prompt(
          "Neue Patientennummer eingeben:",
          trupp.patientInput || ""
        );
        if (newPatient !== null) {
          trupp.patientInput = newPatient.trim();
          saveTrupps();
          renderTrupps();
        }
      }
    </script>
  </body>
</html>
