<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Einsatz-Dashboard</title>
    <style>
      html {
        font-size: 16px;
        height: 100%;
      }
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 15px;
        background: #ffffff;
        color: #333;
        height: 100vh;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      h1 {
        margin: 0 0 15px 0;
        font-size: 2rem;
        text-align: center;
      }
      .dashboard-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        gap: 15px;
      }
      .overview-container {
        display: flex;
        gap: 15px;
        flex: 0 0 auto;
      }
      .overview-section {
        flex: 1;
        background: #fff;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        min-height: 0;
      }
      .overview-section h2 {
        margin: 0 0 10px 0;
        font-size: 1.2rem;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
        text-align: center;
      }
      .overview-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
      }
      .overview-table th,
      .overview-table td {
        padding: 6px 8px;
        border: 1px solid #ddd;
        text-align: left;
      }
      .overview-table th {
        background: #fafafa;
        font-weight: bold;
      }
      .overview-table .status-cell {
        font-weight: bold;
        border-radius: 4px;
        color: #333;
      }
      .grid-patient {
        display: flex;
        justify-content: space-between;
        gap: 15px;
        flex: 0 0 auto;
      }
      .card {
        background: #fff;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        flex: 1;
        text-align: center;
        min-width: 0;
      }
      .card h2 {
        margin: 0 0 8px 0;
        font-size: 1rem;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
      }
      .card .value {
        font-size: 2rem;
        font-weight: bold;
        margin-top: 8px;
      }
      .patients-section {
        flex: 1;
        min-height: 0;
        display: flex;
        flex-direction: column;
      }
      .patients-section h2 {
        margin: 0 0 10px 0;
        font-size: 1.3rem;
      }
      .table-container {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 1rem;
      }
      th,
      td {
        padding: 8px 10px;
        border-bottom: 1px solid #ddd;
        text-align: left;
      }
      th {
        background: #fafafa;
        position: sticky;
        top: 0;
        z-index: 1;
      }
      th.patient-id,
      td.patient-id {
        width: 80px;
      }
      th.gender,
      td.gender {
        width: 60px;
      }
      th.age,
      td.age {
        width: 60px;
      }

      /* ----- Status-Farbgebung ----- */
      tr[data-status="gemeldet"] {
        background: #ffe5e5;
      }
      tr[data-status="disponiert"] {
        background: #ffffe0;
      }
      tr[data-status="in Behandlung"] {
        background: #e2f7e2;
      }
      tr[data-status="verlegt in UHS"] {
        background: #e0f0ff;
      }
      tr[data-status="Behandlung in UHS"] {
        background: #d0e6ff;
      }

      /* U18 Badge Styling */
      .badge-u18 {
        display: inline-block;
        background-color: #fff9c4;
        margin-left: 0.4em;
        padding: 0.1em 0.4em;
        border: 1px solid #333;
        border-radius: 3px;
        font-size: 0.75em;
        vertical-align: middle;
}
      td.trupp-name {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      
      /* Responsive adjustments */
      @media (max-width: 1200px) {
        .grid-patient {
          flex-wrap: wrap;
        }
        .card {
          flex: 1 1 calc(50% - 7.5px);
        }
      }
      
      @media (max-width: 768px) {
        body {
          padding: 10px;
        }
        .overview-container {
          flex-direction: column;
        }
        .card {
          flex: 1 1 100%;
        }
        .overview-table,
        table {
          font-size: 0.8rem;
        }
        th, td {
          padding: 6px 8px;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Patienten-ZÃ¤hler -->
      <div class="grid-patient">
        <div class="card">
          <h2>Aktive Patienten</h2>
          <div id="count-patients" class="value">â€“</div>
        </div>
        <div class="card">
          <h2>Patienten in UHS</h2>
          <div id="count-inUHS" class="value">â€“</div>
        </div>
        <div class="card">
          <h2>Ambulant versorgte Patienten</h2>
          <div id="count-discharged" class="value">â€“</div>
        </div>
        <div class="card">
          <h2>Transportierte Patienten</h2>
          <div id="count-transport" class="value">â€“</div>
        </div>
      </div>
      
      <!-- Ãœbersichten fÃ¼r Trupps und RTMs nebeneinander -->
      <div class="overview-container">
        <div class="overview-section">
          <h2>Trupp Ãœbersicht</h2>
          <table class="overview-table">
            <thead>
              <tr>
                <th>Trupp</th>
                <th>Status</th>
                <th>Patient/Einsatzort</th>
              </tr>
            </thead>
            <tbody id="trupp-overview">
              <tr>
                <td colspan="3">Keine Daten</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="overview-section">
          <h2>RTM Ãœbersicht</h2>
          <table class="overview-table">
            <thead>
              <tr>
                <th>RTM</th>
                <th>Status</th>
                <th>Patient/Einsatzort</th>
              </tr>
            </thead>
            <tbody id="rtm-overview">
              <tr>
                <td colspan="3">Keine Daten</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="patients-section">
        <h2>Aktuelle Patienten</h2>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th class="patient-id">Patient Nr.</th>
                <th>Status</th>
                <th>Trupps</th>
                <th>RTM</th>
                <th class="age">Alter</th>
                <th class="gender">Geschlecht</th>
                <th>Verdachtsdiagnose</th>
                <th>Standort</th>
              </tr>
            </thead>
            <tbody id="patient-list">
              <tr>
                <td colspan="8">Keine Daten</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script src="../scripts/status_options.js"></script>
    <script>
      function getStatusText(statusCode) {
        const statusOption = window.statusOptions.find(option => option.status === statusCode);
        return statusOption ? `${statusCode} - ${statusOption.text}` : `Status ${statusCode}`;
      }

      function getStatusColor(statusCode) {
        const statusOption = window.statusOptions.find(option => option.status === statusCode);
        return statusOption ? statusOption.color : '#ffffff';
      }

      function renderDashboard() {
        // Load the U18 list
        const u18List = JSON.parse(localStorage.getItem('u18Trupps') || '[]');
        
        // Trupp-Ãœbersicht
        const trupps = JSON.parse(localStorage.getItem("trupps") || "[]");
        const truppOverview = document.getElementById("trupp-overview");
        if (!trupps.length) {
          truppOverview.innerHTML = `<tr><td colspan="3">Keine Daten</td></tr>`;
        } else {
          truppOverview.innerHTML = trupps
            .sort((a, b) => a.name.localeCompare(b.name))
            .map((t) => {
              const isU18 = u18List.includes(t.name);
              
              // Determine what to show in the third column based on status
              let thirdColumn = t.patientInput || "â€“";
              if (t.status === 11 && t.currentOrt) {
                thirdColumn = `<span title="Einsatzort">ðŸš© ${t.currentOrt}</span>`;
              }
              
              return `
              <tr>
                <td class="trupp-name">
                  ${t.name}
                  ${isU18 ? '<span class="badge-u18">U18</span>' : ''}
                </td>
                <td class="status-cell" style="background-color: ${getStatusColor(t.status)};">${getStatusText(t.status)}</td>
                <td>${thirdColumn}</td>
              </tr>
            `;})
            .join("");
        }

        // RTM-Ãœbersicht
        const patients = JSON.parse(localStorage.getItem("patients") || "[]");
        const rtms = JSON.parse(localStorage.getItem("rtms") || "[]");
        const rtmOverview = document.getElementById("rtm-overview");
        if (!rtms.length) {
          rtmOverview.innerHTML = `<tr><td colspan="3">Keine Daten</td></tr>`;
        } else {
          rtmOverview.innerHTML = rtms
            .sort((a, b) => a.name.localeCompare(b.name))
            .map((r) => {
              const statusText = getStatusText(r.status) || "â€“";
              const statusColor = r.status !== undefined ? getStatusColor(r.status) : '#ffffff';
              
              // Determine what to show in the third column based on status
              let thirdColumn = "â€“";

              // First priority: Use patientInput if available AND the patient is still active
              if (r.patientInput) {
                // Find the patient to verify they're still active
                const patient = patients.find(p => 
                  (p.id === r.patientInput || p.id === parseInt(r.patientInput)) &&
                  p.status !== "Entlassen" && 
                  p.status !== "Transport in KH"
                );
                
                if (patient) {
                  thirdColumn = r.patientInput;
                }
              }
              // Second priority: For status 11 (Streife), show location
              else if (r.status === 11 && r.currentOrt) {
                thirdColumn = `<span title="Einsatzort">ðŸš© ${r.currentOrt}</span>`;
              }
              // Fallback: Try to find active patient with this RTM in their rtm field
              else {
                const patient = patients.find(p => 
                  p.rtm && 
                  (
                    (typeof p.rtm === 'string' && p.rtm.includes(r.name)) ||
                    (Array.isArray(p.rtm) && p.rtm.includes(r.name))
                  ) &&
                  p.status !== "Entlassen" && 
                  p.status !== "Transport in KH"
                );
                if (patient) {
                  thirdColumn = patient.id;
                }
              }
              
              return `
                <tr>
                  <td>${r.name}</td>
                  <td class="status-cell" style="background-color: ${statusColor};">${statusText}</td>
                  <td>${thirdColumn}</td>
                </tr>
              `;
            }).join("");
        }

        // Patienten-ZÃ¤hler
        const all = JSON.parse(localStorage.getItem("patients") || "[]");
        const active = all.filter(
          (p) => p.status !== "Entlassen" && p.status !== "Transport in KH"
        );
        document.getElementById("count-patients").textContent = active.length;
        document.getElementById("count-inUHS").textContent = all.filter(
          (p) => p.status === "Behandlung in UHS"
        ).length;
        document.getElementById("count-discharged").textContent = all.filter(
          (p) => p.status === "Entlassen"
        ).length;
        document.getElementById("count-transport").textContent = all.filter(
          (p) => p.status === "Transport in KH"
        ).length;

        // Patienten-Tabelle
        const tbody = document.getElementById("patient-list");
        if (!active.length) {
          tbody.innerHTML = `<tr><td colspan="8">Keine Daten</td></tr>`;
        } else {
          tbody.innerHTML = active
            .sort((a, b) => a.id - b.id)
            .map((p) => {
              const showLoc = [
                "gemeldet",
                "disponiert",
                "in Behandlung",
              ].includes(p.status);

              // Escape status fÃ¼r data-attribute
              const statusAttr = p.status.replace(/"/g, "&quot;");

              // Zuordnung der Trupps (Mehrere Trupps untereinander anzeigen)
              const trupp =
                trupps
                  .filter((t) => t.patientInput === p.id)
                  .map((t) => t.name)
                  .join("<br>") || "â€“";

              // RTM: Fehlerbehandlung und TypÃ¼berprÃ¼fung
              let rtm = "â€“"; // Standardwert

              // Wenn p.rtm ein String ist, teilen wir es bei Kommas und fÃ¼gen <br> ein
              if (typeof p.rtm === "string" && p.rtm.trim() !== "") {
                rtm = p.rtm.split(",").join("<br>");
              }
              // Wenn p.rtm ein Array ist, kombinieren wir es mit <br>
              else if (Array.isArray(p.rtm)) {
                rtm = p.rtm.join("<br>");
              }
              // Falls p.rtm ein Objekt oder anderer nicht-String-Typ ist, lassen wir es als "-"
              else if (p.rtm && typeof p.rtm !== "string") {
                rtm = "â€“";
              }

              return `
              <tr data-status="${statusAttr}">
                <td>${p.id}</td>
                <td>${p.status}</td>
                <td>${trupp}</td>  <!-- Trupps untereinander -->
                <td>${rtm}</td>    <!-- RTM untereinander -->
                <td>${p.age || "â€“"}</td>
                <td>${p.gender || "â€“"}</td>
                <td>${p.diagnosis || "â€“"}</td>
                <td>${showLoc ? p.location || "â€“" : ""}</td>
              </tr>
            `;
            })
            .join("");
        }
      }

      document.addEventListener("DOMContentLoaded", renderDashboard);
      window.addEventListener("storage", renderDashboard);
      setInterval(renderDashboard, 30000);
    </script>
  </body>
</html>
