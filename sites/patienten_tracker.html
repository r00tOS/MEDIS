<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Patienten-Tracking</title>
    <link rel="stylesheet" href="../styles/main.css" />
    <link rel="stylesheet" href="../styles/patient.css" />
  </head>
  <body>
    <header>
      <button id="btnNewPatient">Neuen Patienten erstellen</button>
    </header>

    <!-- Bereich, der für den Export genutzt wird -->
    <main id="exportArea">
      <section id="sectionActive">
        <h2>Aktiv</h2>
        <div id="activePatients"></div>
      </section>
      <section id="sectionInUHS">
        <h2>In UHS</h2>
        <div id="inUhsPatients"></div>
      </section>
      <section id="sectionDismissed">
        <h2>Entlassen</h2>
        <div id="dismissedPatients"></div>
      </section>
    </main>
    <script src="categories.js"></script>
    <script src="../scripts/patient_logic.js"></script>
    <script src="../scripts/main.js"></script>
    <!-- html2canvas für jsPDF.html() -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    

    <script>
      const alarmConfig = window.alarmConfig.categories;
      function recordStatusChange(patient, newStatus) {
        const now = Date.now();
        patient.statusTimestamps = patient.statusTimestamps || {};
        patient.durations = patient.durations || {};

        // 1) Timestamp für den neuen Status nur einmal setzen
        if (!patient.statusTimestamps[newStatus]) {
          patient.statusTimestamps[newStatus] = now;
        }

        // 2) Einsatzdauer → erst beim finalen Status
        if (
          (newStatus === "Entlassen" || newStatus === "Transport in KH") &&
          !patient.durations.einsatzdauer
        ) {
          patient.durations.einsatzdauer = formatMS(now - patient.createdAt);
        }

        // 3) Dispositionsdauer: gemeldet → disponiert
        if (
          newStatus === "disponiert" &&
          patient.statusTimestamps.gemeldet &&
          !patient.durations.dispositionsdauer
        ) {
          patient.durations.dispositionsdauer = formatMS(
            now - patient.statusTimestamps.gemeldet
          );
        }

        // 4) Ausrückdauer: disponiert → in Behandlung/UHS
        if (
          ["in Behandlung", "verlegt in UHS", "Behandlung in UHS"].includes(
            newStatus
          ) &&
          patient.statusTimestamps.disponiert &&
          !patient.durations.ausrueckdauer
        ) {
          patient.durations.ausrueckdauer = formatMS(
            now - patient.statusTimestamps.disponiert
          );
        }

        // 5) Verlegedauer UHS: verlegt in UHS → Behandlung in UHS
        if (
          newStatus === "Behandlung in UHS" &&
          patient.statusTimestamps["verlegt in UHS"] &&
          !patient.durations.verlegedauerUHS
        ) {
          patient.durations.verlegedauerUHS = formatMS(
            now - patient.statusTimestamps["verlegt in UHS"]
          );
        }

        // 6) **Behandlungsdauer**: wenn wir ins Finale wechseln
        if (
          (newStatus === "Entlassen" || newStatus === "Transport in KH") &&
          !patient.durations.behandlungsdauer
        ) {
          // 6a) nimm den Start-Timestamp „in Behandlung“ oder „Behandlung in UHS“
          const start =
            patient.statusTimestamps["in Behandlung"] ||
            patient.statusTimestamps["Behandlung in UHS"];
          if (start) {
            patient.durations.behandlungsdauer = formatMS(now - start);
          } else {
            // falls nie richtig in Behandlung
            patient.durations.behandlungsdauer = "00:00";
          }
        }
        // 7) alle übrigen Dauern beim finalen Status nachtragen
        if (newStatus === "Entlassen" || newStatus === "Transport in KH") {
          // Dispositionsdauer, falls nie auf disponiert gewechselt
          if (
            patient.statusTimestamps.gemeldet &&
            !patient.durations.dispositionsdauer
          ) {
            patient.durations.dispositionsdauer = formatMS(
              now - patient.statusTimestamps.gemeldet
            );
          }
          // Ausrückdauer, falls nie auf disponiert→in Behandlung gewechselt
          if (
            patient.statusTimestamps.disponiert &&
            !patient.durations.ausrueckdauer
          ) {
            patient.durations.ausrueckdauer = formatMS(
              now - patient.statusTimestamps.disponiert
            );
          }
          // Verlegedauer UHS, falls nie auf verlegt→UHS gewechselt
          if (
            patient.statusTimestamps["verlegt in UHS"] &&
            !patient.durations.verlegedauerUHS
          ) {
            patient.durations.verlegedauerUHS = formatMS(
              now - patient.statusTimestamps["verlegt in UHS"]
            );
          }
        }
      }

      // öffnet das Modal mit Keyword-Liste

      let currentPatientId = null;
      let selectedCategory = null;
      let selectedKeyword = null;

      // Wird bei jeder Eingabe im Suchfeld aufgerufen
      function onSearchInput() {
        const term = document
          .getElementById("searchInput")
          .value.trim()
          .toLowerCase();
        const resultsDiv = document.getElementById("searchResults");

        if (term === "") {
          // Leeres Suchfeld → zurück zu normalem Modus
          resultsDiv.style.display = "none";
          document.getElementById("categoryList").style.display = "block";
          document.getElementById("keywordList").style.display = "block";
          return;
        }

        // Suche in allen Kategorien→Keywords
        const hits = [];
        alarmConfig.forEach((cat, ci) => {
          cat.keywords.forEach((kw, ki) => {
            if (kw.word.toLowerCase().includes(term)) {
              hits.push({ ci, ki, word: kw.word });
            }
          });
        });

        // Ergebnis-Liste aufbauen
        resultsDiv.innerHTML = "";
        hits.forEach((hit) => {
          const div = document.createElement("div");
          div.className = "item";
          div.textContent = `${alarmConfig[hit.ci].name} ➔ ${hit.word}`;
          div.onclick = () => {
            // Treffer auswählen und Modal zurücksetzen
            selectedCategory = hit.ci;
            selectedKeyword = hit.ki;
            document.getElementById("searchInput").value = hit.word;
            document.getElementById("otherDetail").style.display =
              /^sonstiger/i.test(hit.word) ? "block" : "none";
          };
          resultsDiv.appendChild(div);
        });

        // UI-Umschaltung
        resultsDiv.style.display = "block";
        document.getElementById("categoryList").style.display = "none";
        document.getElementById("keywordList").style.display = "none";
      }

      function openKeywordModal(patientId) {
        currentPatientId = patientId;
        selectedCategory = null;
        selectedKeyword = null;
        document.getElementById("searchInput").value = "";
        document.getElementById("searchResults").style.display = "none";
        document.getElementById("categoryList").style.display = "block";
        document.getElementById("keywordList").style.display = "block";
        renderCategoryList();
        document.getElementById("keywordList").innerHTML = "";
        document.getElementById("keywordModal").style.display = "flex";
      }

      function renderCategoryList() {
        const catDiv = document.getElementById("categoryList");
        catDiv.innerHTML = "";
        alarmConfig.forEach((c, i) => {
          const d = document.createElement("div");
          d.textContent = c.name;
          d.className = "item" + (selectedCategory === i ? " selected" : "");
          d.onclick = () => {
            selectedCategory = i;
            selectedKeyword = null;
            renderCategoryList();
            renderKeywordList();
          };
          catDiv.appendChild(d);
        });
      }

      function renderKeywordList() {
        const kwDiv = document.getElementById("keywordList");
        kwDiv.innerHTML = "";
        document.getElementById("otherDetail").style.display = "none"; // immer verstecken
        if (selectedCategory === null) return;

        alarmConfig[selectedCategory].keywords.forEach((kw, j) => {
          const d = document.createElement("div");
          d.textContent = kw.word;
          d.className = "item" + (selectedKeyword === j ? " selected" : "");
          d.onclick = () => {
            selectedKeyword = j;
            renderKeywordList();
            // Wenn das Wort mit "sonstiger" (case-insensitive) anfängt → Feld einblenden
            if (/^sonstiger/i.test(kw.word)) {
              document.getElementById("otherDetail").style.display = "block";
              document.getElementById("otherInput").value = "";
            } else {
              document.getElementById("otherDetail").style.display = "none";
            }
          };
          kwDiv.appendChild(d);
        });
      }

      function confirmKeyword() {
        if (selectedCategory === null || selectedKeyword === null) {
          return alert("Bitte Kategorie und Stichwort wählen");
        }
        let cfg = alarmConfig[selectedCategory].keywords[selectedKeyword];
        let finalWord = cfg.word;

        // Wenn Zusatz-Feld sichtbar, hänge den Input an
        if (document.getElementById("otherDetail").style.display === "block") {
          const extra = document.getElementById("otherInput").value.trim();
          if (!extra) {
            return alert("Bitte die Art des Notfalls genauer beschreiben.");
          }
          finalWord += " – " + extra;
        }

        // 1) Diagnosis-Feld setzen
        updatePatientData(currentPatientId, "diagnosis", finalWord);

        // 2) vorgeschlagene Ressourcen speichern
        const patients = JSON.parse(localStorage.getItem("patients")) || [];
        const p = patients.find((x) => x.id === currentPatientId);
        p.suggestedResources = cfg.resources;
        localStorage.setItem("patients", JSON.stringify(patients));

        closeKeywordModal();
        loadPatients(currentPatientId);
      }

      function closeKeywordModal() {
        document.getElementById("keywordModal").style.display = "none";
      }

      document.addEventListener("DOMContentLoaded", () => {
        document
          .getElementById("btnNewPatient")
          .addEventListener("click", createNewPatient);
        loadPatients();
      });


      function formatMS(ms) {
        if (!isFinite(ms) || ms < 0) return "–";
        const totalSec = Math.floor(ms / 1000);
        const mm = String(Math.floor(totalSec / 60)).padStart(2, "0");
        const ss = String(totalSec % 60).padStart(2, "0");
        return `${mm}:${ss}`;
      }

      function getCurrentTime() {
        return new Date().toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function getNextPatientId() {
        const patients = JSON.parse(localStorage.getItem("patients")) || [];
        return patients.length + 1;
      }

      function createNewPatient() {
        // TODO: Warum nicht direkt loadPatients(newPatient())
        // 1) neuen Patient anlegen und ID zurückbekommen
        const id = newPatient({
          // optional: team, location, initialStatus
          // team: [], location: "", initialStatus: "gemeldet"
        });
        // 2) UI aktualisieren, highlight-ID übergeben wenn gewünscht
        loadPatients(id);
      }
        

      

      /**
       * Deaktiviert alle Checkboxen mit demselben name außer der gerade geklickten.
       */
      function selectOnly(box) {
        const gruppe = document.getElementsByName(box.name);
        gruppe.forEach((cb) => {
          if (cb !== box) cb.checked = false;
        });
        // Falls der Klick eine Checkbox deaktiviert hat, sorgen wir dafür,
        // dass mindestens eine immer ausgewählt bleibt:
        if (!box.checked) {
          box.checked = true;
        }
      }


      function promptAddEntry(id) {
        const text = prompt("Bitte Eintrag eingeben:");
        if (text && text.trim()) {
          addCustomHistory(id, text.trim());
        }
      }

      function assignResource(id, type) {
        const label = type === "team" ? "Trupp" : "RTM";
        const value = prompt(`${label} disponieren:`);
        if (value !== null && value.trim() !== "") {
          const patients = JSON.parse(localStorage.getItem("patients")) || [];
          const patient = patients.find((p) => p.id === id);
          if (type === "team") {
            if (!Array.isArray(patient.team)) patient.team = [];
            patient.team.push(value);
          } else {
            if (!Array.isArray(patient.rtm)) patient.rtm = [];
            patient.rtm.push(value);
          }
          // Nur wenn vorher noch kein Trupp und kein RTM zugewiesen war:
          if (
            patient.status !== "in Behandlung" &&
            (!Array.isArray(patient.team) || patient.team.length === 0) &&
            (!Array.isArray(patient.rtm) || patient.rtm.length === 0)
          ) {
            patient.status = "disponiert";
            patient.history = patient.history || [];
            patient.history.push(`${getCurrentTime()} Status: disponiert`);
          }
          // Und immer Eintrag, dass RTM disponiert wurde:
          patient.history = patient.history || [];
          patient.history.push(
            `${getCurrentTime()} ${label} ${value} disponiert`
          );

          localStorage.setItem("patients", JSON.stringify(patients));
          loadPatients();
        }
      }

      function assignSelectedTrupp(patientId) {
        // Patienten laden und Objekt finden
        const patients = JSON.parse(localStorage.getItem("patients")) || [];
        const p = patients.find((x) => x.id === patientId);
        if (!p) return;

        // Sicherstellen, dass p.team ein Array ist
        if (!Array.isArray(p.team)) p.team = [];

        // ①: Status-Logik & Timestamp setzen, bevor irgendwas anderes passiert
        recordStatusChange(p, "disponiert");

        // ②: Wenn noch kein Trupp/RTM und Status nicht 'in Behandlung', auf 'disponiert' setzen
        if (
          p.status !== "in Behandlung" &&
          p.team.length === 0 &&
          (!Array.isArray(p.rtm) || p.rtm.length === 0)
        ) {
          p.status = "disponiert";
          p.history = p.history || [];
          p.history.push(`${getCurrentTime()} Status: disponiert`);
        }

        // ③: Tatsächlichen Trupp-Namen aus dem Select ziehen
        const sel = document.getElementById(`teamSelect-${patientId}`);
        const truppName = sel ? sel.value : null;
        if (!truppName) {
          // Nichts ausgewählt → abbrechen
          localStorage.setItem("patients", JSON.stringify(patients));
          return;
        }

        // ④: Trupp zu p.team hinzufügen und Historie eintragen
        p.team.push(truppName);
        p.history.push(`${getCurrentTime()} Trupp ${truppName} disponiert`);

        // ⑤: Speichern und neu rendern
        localStorage.setItem("patients", JSON.stringify(patients));
        loadPatients(patientId);

        // ⑥: Trupp-Tracker aktualisieren (Einsatzzeit starten)
        const trupps = JSON.parse(localStorage.getItem("trupps")) || [];
        const t = trupps.find((t) => t.name === truppName);
        if (t) {
          const now = Date.now();

          // a) eventuell laufenden Einsatz beenden
          if (t.currentOrt && t.einsatzStartOrt) {
            t.einsatzHistorie = t.einsatzHistorie || [];
            t.einsatzHistorie.push({
              ort: t.currentOrt,
              von: t.einsatzStartOrt,
              bis: now,
            });
          }

          // b) Status auf Patient setzen
          t.status = "Patient";
          t.patientInput = patientId;
          // c) Einsatz-Timer starten
          t.patientStart = now;
          t.currentEinsatzStart = now;
          // d) Pause-Timer zurücksetzen
          t.currentPauseStart = null;

          // e) Speichern & Storage-Event feuern
          localStorage.setItem("trupps", JSON.stringify(trupps));
          window.dispatchEvent(
            new StorageEvent("storage", {
              key: "trupps",
              newValue: JSON.stringify(trupps),
            })
          );
        }
      }

      function removeTrupp(id, index) {
        if (!confirm("Soll dieser Trupp wirklich entfernt werden?")) return;

        // 1) Patienten-Seite updaten
        const patients = JSON.parse(localStorage.getItem("patients")) || [];
        const patient = patients.find((p) => p.id === id);
        const removed = Array.isArray(patient.team)
          ? patient.team.splice(index, 1)
          : [];
        patient.history = patient.history || [];
        patient.history.push(
          `${getCurrentTime()} Trupp ${removed[0]} entfernt`
        );
        localStorage.setItem("patients", JSON.stringify(patients));
        loadPatients();

        // 2) Trupp-Tracker updaten
        const trupps = JSON.parse(localStorage.getItem("trupps")) || [];
        const t = trupps.find((t) => t.name === removed[0]);
        if (t) {
          const now = Date.now();

          // 📝 Falls gerade ein Patient zugewiesen, Patienteneinsatz abschließen
          if (t.patientInput && t.patientStart) {
            t.patientHistorie = t.patientHistorie || [];
            t.patientHistorie.push({
              nummer: t.patientInput,
              von: t.patientStart,
              bis: now,
            });
            // Reset der Patientendaten
            t.patientInput = "";
            t.patientStart = null;
          }

          // Statuswechsel, aber Einsatzzeit weiterlaufen lassen
          t.status = "Einsatz beendet";

          // Eigene Trupp-Historie ergänzen
          t.history = t.history || [];
          t.history.push({
            when: now,
            event: "Einsatz beendet",
          });

          // Speichern und Renderer anstoßen
          localStorage.setItem("trupps", JSON.stringify(trupps));
          window.dispatchEvent(
            new StorageEvent("storage", {
              key: "trupps",
              newValue: JSON.stringify(trupps),
            })
          );
        }
      }

      function removeRtm(id, index) {
        if (!confirm("Soll dieses RTM wirklich entfernt werden?")) return;
        const patients = JSON.parse(localStorage.getItem("patients")) || [];
        const patient = patients.find((p) => p.id === id);
        if (Array.isArray(patient.rtm)) {
          const removed = patient.rtm.splice(index, 1);
          if (!patient.history) patient.history = [];
          patient.history.push(
            `${getCurrentTime()} RTM ${removed[0]} entfernt`
          );
          localStorage.setItem("patients", JSON.stringify(patients));
          loadPatients();
        }
      }

      function editField(id, field) {
        if (field === "diagnosis") {
          // Modal für Stichwörter öffnen
          openKeywordModal(id);
          return;
        }
        // für alle anderen Felder weiter wie gehabt:
        const patients = JSON.parse(localStorage.getItem("patients")) || [];
        const patient = patients.find((p) => p.id === id);
        const current = patient[field] || "";
        const labelMap = {
          age: "Alter",
          diagnosis: "Verdachtsdiagnose",
          location: "Standort",
          remarks: "Bemerkungen",
        };
        const value = prompt(
          `Neuen Wert für ${labelMap[field] || field} eingeben:`,
          current
        );
        if (value !== null) {
          updatePatientData(id, field, value);
        }
      }

      function addCustomHistory(id, message) {
        if (!message.trim()) return;
        const patients = JSON.parse(localStorage.getItem("patients")) || [];
        const patient = patients.find((p) => p.id === id);
        if (!patient.history) patient.history = [];
        patient.history.push(`${getCurrentTime()} ${message}`);
        localStorage.setItem("patients", JSON.stringify(patients));
        loadPatients();
      }

      // Globale Variable, die immer aktuell ist
      window.nextPatientNumber =
        parseInt(localStorage.getItem("nextPatientNumber"), 10) || 1;

      // 1) Polling
      function syncNextPatientNumber() {
        window.nextPatientNumber =
          parseInt(localStorage.getItem("nextPatientNumber"), 10) || 1;
      }
      setInterval(syncNextPatientNumber, 2000);

      // 2) storage-Event
      window.addEventListener("storage", (e) => {
        if (e.key === "nextPatientNumber") syncNextPatientNumber();
      });

      window.addEventListener("storage", (e) => {
        if (e.key === "patients") {
          loadPatients();
        }
      });

      /**
       * Sammelt alle relevanten Felddaten des Patienten, formatiert sie
       * und kopiert den resultierenden Text in die Zwischenablage.
       */
      function copyPatientData(id) {
        // Patientendaten laden
        const patients = JSON.parse(localStorage.getItem("patients")) || [];
        const patient = patients.find((p) => p.id === id);
        if (!patient) return;

        // Felder extrahieren
        const trupp = Array.isArray(patient.team)
          ? patient.team.join(", ")
          : "–";
        const rtm = Array.isArray(patient.rtm) ? patient.rtm.join(", ") : "–";
        const nachf =
          (patient.history || [])
            .filter((e) => /nachgefordert/.test(e))
            .join("\n") || "–";
        const remarks = patient.remarks || "–";
        const historyText = (patient.history || []).join("\n") || "–";

        // Textblock zusammenbauen
        const text = `Patient Nr.: ${patient.id}
Trupp: ${trupp}
RTM: ${rtm}
Standort: ${patient.location || "–"}
Alter: ${patient.age || "–"}
Geschlecht: ${patient.gender || "–"}
Verdachtsdiagnose: ${patient.diagnosis || "–"}
Nachforderungen:
${nachf}
Bemerkung: ${remarks}

Patienten-Historie:
${historyText}`;

        copyToClipboard(text);
      }

      /**
       * Kopiert reinen Text in die Zwischenablage, mit Fallback.
       */
      function copyToClipboard(text) {
        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard.writeText(text).catch((err) => {
            console.error("Clipboard write failed, fallback:", err);
            fallbackCopyTextToClipboard(text);
          });
        } else {
          fallbackCopyTextToClipboard(text);
        }
      }

      function fallbackCopyTextToClipboard(text) {
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed"; // verhindert Scroll-Jump
        ta.style.opacity = "0";
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        try {
          document.execCommand("copy");
          alert("Patientendaten kopiert 🎉");
        } catch (err) {
          console.error("Fallback: Copy failed", err);
        }
        document.body.removeChild(ta);
      }

      function deletePatient(id) {
        if (!confirm("Soll Patient " + id + " wirklich gelöscht werden?"))
          return;
        // aus localStorage holen
        const patients = JSON.parse(localStorage.getItem("patients")) || [];
        // Patient finden und entfernen
        const idx = patients.findIndex((p) => p.id === id);
        if (idx > -1) {
          patients.splice(idx, 1);
          localStorage.setItem("patients", JSON.stringify(patients));
          // neu rendern
          loadPatients();
        }
      }

      window.addEventListener("storage", (e) => {
        if (e.key !== "trupps") return;
        const newTrupps = JSON.parse(e.newValue || "[]");
        const patients = JSON.parse(localStorage.getItem("patients")) || [];
        let dirty = false;

        // 1) Nur bei aktiven Patient:innen: Trupp/RTM rausfiltern
        patients.forEach((patient) => {
          // Skip bei finalen Status
          if (
            patient.status === "Entlassen" ||
            patient.status === "Transport in KH"
          ) {
            return;
          }
          if (!Array.isArray(patient.team)) return;

          const before = [...patient.team];
          patient.team = patient.team.filter((name) => {
            const t = newTrupps.find((t) => t.name === name);
            return t && t.status === "Patient";
          });

          before.forEach((name) => {
            if (!patient.team.includes(name)) {
              patient.history = patient.history || [];
              patient.history.push(
                `${getCurrentTime()} Trupp ${name} entfernt (via Trupp-Tracker)`
              );
              dirty = true;
            }
          });

          // (Optional) exakt dasselbe für RTM, falls Ihr das nutzt:
          // if (Array.isArray(patient.rtm)) {
          //   const beforeR = [...patient.rtm];
          //   patient.rtm = patient.rtm.filter(name => {
          //     const t = newTrupps.find(t => t.name === name);
          //     return t && t.status === 'Patient';
          //   });
          //   // … Historie-Einträge analog …
          // }
        });

        // 2) Nur bei aktiven Patient:innen: Wenn kein Trupp UND kein RTM → gemeldet
        patients.forEach((patient) => {
          // Wieder Skip bei finalen Status
          if (
            patient.status === "Entlassen" ||
            patient.status === "Transport in KH"
          ) {
            return;
          }
          const noTrupp =
            !Array.isArray(patient.team) || patient.team.length === 0;
          const noRtm = !Array.isArray(patient.rtm) || patient.rtm.length === 0;
          if (noTrupp && noRtm && patient.status !== "gemeldet") {
            patient.status = "gemeldet";
            patient.history = patient.history || [];
            patient.history.push(`${getCurrentTime()} Status: gemeldet`);
            dirty = true;
          }
        });

        if (dirty) {
          localStorage.setItem("patients", JSON.stringify(patients));
          loadPatients();
        }
      });

      // ENTER-Taste in Modal abfangen und bestätigen
      document.addEventListener("keydown", function (e) {
        const modal = document.getElementById("keywordModal");
        if (modal && modal.style.display === "flex" && e.key === "Enter") {
          e.preventDefault();
          confirmKeyword();
        }
      });

      // 1) Live-Timer updaten
      function updateLiveTimers() {
        const patients = JSON.parse(localStorage.getItem("patients")) || [];
        const now = Date.now();
        let dirty = false;

        patients.forEach((p) => {
          const isFinal =
            p.status === "Entlassen" || p.status === "Transport in KH";
          if (isFinal) return;
          const t = p.statusTimestamps || {};
          const d = (p.durations ||= {});
          const id = p.id;

          // 1) Einsatzdauer → läuft bis final
          if (!isFinal) {
            const val = formatMS(now - p.createdAt);
            const el = document.querySelector(
              `.timer.einsatzdauer[data-id='${id}']`
            );
            if (el) el.textContent = val;
            if (d.einsatzdauer !== val) {
              d.einsatzdauer = val;
              dirty = true;
            }
          }

          // 2) Dispositionsdauer → nur bis dispo gesetzt
          if (t.gemeldet && !t.disponiert) {
            const val = formatMS(now - t.gemeldet);
            const el = document.querySelector(
              `.timer.dispositionsdauer[data-id='${id}']`
            );
            if (el) el.textContent = val;
            if (d.dispositionsdauer !== val) {
              d.dispositionsdauer = val;
              dirty = true;
            }
          }

          // 3) Ausrückdauer → nur zwischen dispo und Behandlungs-/UHS-Start
          if (
            t.disponiert &&
            !t["in Behandlung"] &&
            !t["verlegt in UHS"] &&
            !t["Behandlung in UHS"]
          ) {
            const val = formatMS(now - t.disponiert);
            const el = document.querySelector(
              `.timer.ausrueckdauer[data-id='${id}']`
            );
            if (el) el.textContent = val;
            if (d.ausrueckdauer !== val) {
              d.ausrueckdauer = val;
              dirty = true;
            }
          }

          // 4) Verlegedauer UHS → von verlegt → Behandlung in UHS
          if (t["verlegt in UHS"] && !t["Behandlung in UHS"]) {
            const val = formatMS(now - t["verlegt in UHS"]);
            const el = document.querySelector(
              `.timer.verlegedauerUHS[data-id='${id}']`
            );
            if (el) el.textContent = val;
            if (d.verlegedauerUHS !== val) {
              d.verlegedauerUHS = val;
              dirty = true;
            }
          }

          // 5) Behandlungsdauer → läuft während in Behandlung oder UHS-Behandlung
          const behandlungsStart = t["in Behandlung"] ?? t["Behandlung in UHS"];
          if (behandlungsStart && !isFinal) {
            const val = formatMS(now - behandlungsStart);
            const el = document.querySelector(
              `.timer.behandlungsdauer[data-id='${id}']`
            );
            if (el) el.textContent = val;
            if (d.behandlungsdauer !== val) {
              d.behandlungsdauer = val;
              dirty = true;
            }
          }
        });
      }

      // weiter wie gehabt
      setInterval(updateLiveTimers, 1000);

      setInterval(updateLiveTimers, 1000);
    </script>
    <!-- Stichwort-Modal -->
    <div id="keywordModal" class="modal" style="display: none">
      <div class="modal-content">
        <span class="close" onclick="closeKeywordModal()">&times;</span>
        <h2>Stichwort auswählen</h2>

        <!-- ① Suchfeld -->
        <input
          type="text"
          id="searchInput"
          placeholder="Stichwort suchen…"
          style="
            width: 100%;
            padding: 6px;
            margin-bottom: 10px;
            box-sizing: border-box;
          "
          oninput="onSearchInput()"
        />

        <div style="display: flex; gap: 10px; height: 400px">
          <!-- ② Kategorien-Liste -->
          <div id="categoryList" class="list"></div>
          <!-- ③ Stichwort-Liste -->
          <div id="keywordList" class="list"></div>
          <!-- ④ Such-Ergebnis-Liste (initial versteckt) -->
          <div id="searchResults" class="list" style="display: none"></div>
        </div>

        <!-- Zusatzfeld für „sonstiger … Notfall“ -->
        <div id="otherDetail" style="margin-top: 10px; display: none">
          <label for="otherInput"
            ><strong>Bitte genauer beschreiben:</strong></label
          ><br />
          <input
            type="text"
            id="otherInput"
            style="width: 100%; padding: 6px; box-sizing: border-box"
          />
        </div>

        <button onclick="confirmKeyword()">Bestätigen</button>
      </div>
    </div>
  </body>
</html>
