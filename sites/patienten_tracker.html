<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Patienten-Tracking</title>
    <link rel="stylesheet" href="../styles/main.css" />
    <link rel="stylesheet" href="../styles/patient.css" />
    <link rel="stylesheet" href="../styles/disposition_status.css" />
    <link rel="stylesheet" href="../styles/context_menu.css" />
    <script src="../scripts/categories.js"></script>
    <script src="../scripts/logic_patient.js"></script>
    <script src="../scripts/render_patients.js"></script>
    <script src="../scripts/status_options.js"></script>
    <script src="../scripts/logic_trupp.js"></script>
    <script src="../scripts/render_trupps.js"></script>
  </head>
  <body>
    <script src="../scripts/main.js"></script>
    <script src="../scripts/keyword_modal.js"></script>
    <script src="../scripts/modal.js"></script>
    <header>
      <button id="btnNewPatient">Neuen Patienten erstellen</button>
    </header>

    <!-- Bereich, der für den Export genutzt wird -->
    <main id="exportArea">
      <section id="sectionActive">
        <h2>Aktiv</h2>
        <div id="activePatients"></div>
      </section>
      <section id="sectionInUHS">
        <h2>In UHS</h2>
        <div id="inUhsPatients"></div>
      </section>
      <section id="sectionDismissed">
        <h2>Entlassen</h2>
        <div id="dismissedPatients"></div>
      </section>
    </main>
    <script>
      //event listener für den Button "Neuen Patienten erstellen"
      document.getElementById("btnNewPatient").addEventListener("click", () => {
        const id = newPatient({});
        loadPatients(id);
        openEditModal(id);
      });

      function formatMS(ms) {
        if (!isFinite(ms) || ms < 0) return "–";
        const totalSec = Math.floor(ms / 1000);
        const mm = String(Math.floor(totalSec / 60)).padStart(2, "0");
        const ss = String(totalSec % 60).padStart(2, "0");
        return `${mm}:${ss}`;
      }

      /**
       * Deaktiviert alle Checkboxen mit demselben name außer der gerade geklickten.
       */
      function selectOnly(box) {
        const gruppe = document.getElementsByName(box.name);
        gruppe.forEach((cb) => {
          if (cb !== box) cb.checked = false;
        });
        // Falls der Klick eine Checkbox deaktiviert hat, sorgen wir dafür,
        // dass mindestens eine immer ausgewählt bleibt:
        if (!box.checked) {
          box.checked = true;
        }
      }

      function promptAddEntry(id) {
        const text = prompt("Bitte Eintrag eingeben:");
        if (text && text.trim()) {
          addCustomHistory(id, text.trim());
        }
      }

      // Funktion um Disposition-Status nach Diagnose-Änderung zu aktualisieren
      function updateDispositionAfterDiagnosisChange(patientId) {
        // Patient-Karten neu laden um die aktualisierten Disposition-Symbole anzuzeigen
        if (typeof loadPatients === 'function') {
          loadPatients(patientId);
        }
        
        // Auch Trupp-Karten aktualisieren falls sie Disposition-Symbole anzeigen
        if (typeof updatePatientDispositionStatus === 'function') {
          const patients = JSON.parse(localStorage.getItem("patients")) || [];
          const patient = patients.find(p => p.id === patientId);
          if (patient) {
            const trupps = JSON.parse(localStorage.getItem("trupps")) || [];
            const rtms = JSON.parse(localStorage.getItem("rtms")) || [];
            updatePatientDispositionStatus(patient, trupps, rtms);
          }
        }
      }

      window.addEventListener("storage", (e) => {
        if (e.key === "trupps") {
          // 1) Trupps aus dem Storage parsen
          const newTrupps = JSON.parse(e.newValue || "[]");
          // 2) immer neu rendern, damit frisch angemeldete Trupps im Patientendropdown auftauchen
          loadPatients();

          // 3) jetzt erst die Patienten aus Storage holen
          const patients = JSON.parse(localStorage.getItem("patients")) || [];
          let dirty = false;

          // 4) Entferne alle Trupp-Namen, die nicht mehr Status 3 haben
patients.forEach((patient) => {
  // WICHTIG: Finale Status schützen - erweiterte Prüfung
  const isFinalState = patient.status === "Entlassen" || 
                      patient.status === "Transport in KH" ||
                      patient.transport ||  // Hat Transport-Ziel
                      patient.discharge;    // Hat Entlassungsort
  
  if (isFinalState) return;
  
  if (!Array.isArray(patient.team)) return;

  const keepStatuses = [3, 4, 7, 8];              // diese Status sollen behalten werden
  const before = [...patient.team];
  patient.team = patient.team.filter((name) => {
    const t = newTrupps.find((x) => x.name === name);
    return t && keepStatuses.includes(t.status);
  });

  before.forEach((name) => {
    if (!patient.team.includes(name)) {
      patient.history = patient.history || [];
      patient.history.push(
        `${getCurrentTime()} Trupp ${name} entfernt (via Trupp-Tracker)`
      );
      dirty = true;
    }
            });
          });

          // 5) Falls jetzt keine Trupps oder RTMs mehr dran hängen → zurück auf "gemeldet"
          // ABER NUR wenn Patient nicht in finalem Status ist
          patients.forEach((patient) => {
            // WICHTIG: Finale Status schützen - erweiterte Prüfung
            const isFinalState = patient.status === "Entlassen" || 
                                patient.status === "Transport in KH" ||
                                patient.transport ||  // Hat Transport-Ziel
                                patient.discharge;    // Hat Entlassungsort
            
            if (isFinalState) return;
            
            const noTrupp =
              !Array.isArray(patient.team) || patient.team.length === 0;
            const noRtm =
              !Array.isArray(patient.rtm) || patient.rtm.length === 0;
            if (noTrupp && noRtm && patient.status !== "gemeldet") {
              patient.status = "gemeldet";
              patient.history = patient.history || [];
              patient.history.push(`${getCurrentTime()} Status: gemeldet`);
              dirty = true;
            }
          });

          // 6) Wenn sich etwas geändert hat, speichern & neu rendern
          if (dirty) {
            localStorage.setItem("patients", JSON.stringify(patients));
            loadPatients();
          }
        }
        
        if (e.key === "patients") {
          // Bei Patient-Änderungen nur neu laden, KEINE Disposition-Updates
          loadPatients();
          
          // REMOVED: triggerDispositionUpdate() - was causing save conflicts
          // Disposition updates will be handled through direct logic in assignResource() etc.
        }
      });

      // ENTER-Taste in Modal abfangen und bestätigen
      document.addEventListener("keydown", function (e) {
        const modal = document.getElementById("keywordModal");
        if (modal && modal.style.display === "flex" && e.key === "Enter") {
          e.preventDefault();
          confirmEdit();
        }
      });

      // DISPOSITION UPDATE LISTENER COMPLETELY DISABLED
      // This was causing conflicts with patient data saving
      // Disposition updates will happen through normal save operations only
      
      if (window.dispositionUpdateListener) {
        window.removeEventListener('dispositionUpdate', window.dispositionUpdateListener);
        window.dispositionUpdateListener = null;
      }
      
      // Remove the save flag as well
      window.isSavingPatientData = false;
    </script>
  </body>
</html>
