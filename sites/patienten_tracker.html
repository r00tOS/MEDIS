<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Patienten-Tracking</title>
    <link rel="stylesheet" href="../styles/main.css" />
    <link rel="stylesheet" href="../styles/patient.css" />
  </head>
  <body>
    <header>
      <button id="btnNewPatient">Neuen Patienten erstellen</button>
    </header>

    <!-- Bereich, der für den Export genutzt wird -->
    <main id="exportArea">
      <section id="sectionActive">
        <h2>Aktiv</h2>
        <div id="activePatients"></div>
      </section>
      <section id="sectionInUHS">
        <h2>In UHS</h2>
        <div id="inUhsPatients"></div>
      </section>
      <section id="sectionDismissed">
        <h2>Entlassen</h2>
        <div id="dismissedPatients"></div>
      </section>
    </main>
    <script src="categories.js"></script>
    <script src="../scripts/patient_logic.js"></script>
    <script src="../scripts/main.js"></script>
    <script src="../scripts/keyword_modal.js"></script>
    <!-- html2canvas für jsPDF.html() -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
      const alarmConfig = window.alarmConfig.categories;

      // öffnet das Modal mit Keyword-Liste

      let currentPatientId = null;
      let selectedCategory = null;
      let selectedKeyword = null;

      // Wird bei jeder Eingabe im Suchfeld aufgerufen

      document.addEventListener("DOMContentLoaded", () => {
        document
          .getElementById("btnNewPatient")
          .addEventListener("click", loadPatients(newPatient()));
        loadPatients();
      });

      function formatMS(ms) {
        if (!isFinite(ms) || ms < 0) return "–";
        const totalSec = Math.floor(ms / 1000);
        const mm = String(Math.floor(totalSec / 60)).padStart(2, "0");
        const ss = String(totalSec % 60).padStart(2, "0");
        return `${mm}:${ss}`;
      }

      function getCurrentTime() {
        return new Date().toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function getNextPatientId() {
        const patients = JSON.parse(localStorage.getItem("patients")) || [];
        return patients.length + 1;
      }

      /**
       * Deaktiviert alle Checkboxen mit demselben name außer der gerade geklickten.
       */
      function selectOnly(box) {
        const gruppe = document.getElementsByName(box.name);
        gruppe.forEach((cb) => {
          if (cb !== box) cb.checked = false;
        });
        // Falls der Klick eine Checkbox deaktiviert hat, sorgen wir dafür,
        // dass mindestens eine immer ausgewählt bleibt:
        if (!box.checked) {
          box.checked = true;
        }
      }

      function promptAddEntry(id) {
        const text = prompt("Bitte Eintrag eingeben:");
        if (text && text.trim()) {
          addCustomHistory(id, text.trim());
        }
      }

      window.addEventListener("storage", (e) => {
        if (e.key !== "trupps") return;
        const newTrupps = JSON.parse(e.newValue || "[]");
        const patients = JSON.parse(localStorage.getItem("patients")) || [];
        let dirty = false;

        // 1) Nur bei aktiven Patient:innen: Trupp/RTM rausfiltern
        patients.forEach((patient) => {
          // Skip bei finalen Status
          if (
            patient.status === "Entlassen" ||
            patient.status === "Transport in KH"
          ) {
            return;
          }
          if (!Array.isArray(patient.team)) return;

          const before = [...patient.team];
          patient.team = patient.team.filter((name) => {
            const t = newTrupps.find((t) => t.name === name);
            return t && t.status === "Patient";
          });

          before.forEach((name) => {
            if (!patient.team.includes(name)) {
              patient.history = patient.history || [];
              patient.history.push(
                `${getCurrentTime()} Trupp ${name} entfernt (via Trupp-Tracker)`
              );
              dirty = true;
            }
          });

          // (Optional) exakt dasselbe für RTM, falls Ihr das nutzt:
          // if (Array.isArray(patient.rtm)) {
          //   const beforeR = [...patient.rtm];
          //   patient.rtm = patient.rtm.filter(name => {
          //     const t = newTrupps.find(t => t.name === name);
          //     return t && t.status === 'Patient';
          //   });
          //   // … Historie-Einträge analog …
          // }
        });

        // 2) Nur bei aktiven Patient:innen: Wenn kein Trupp UND kein RTM → gemeldet
        patients.forEach((patient) => {
          // Wieder Skip bei finalen Status
          if (
            patient.status === "Entlassen" ||
            patient.status === "Transport in KH"
          ) {
            return;
          }
          const noTrupp =
            !Array.isArray(patient.team) || patient.team.length === 0;
          const noRtm = !Array.isArray(patient.rtm) || patient.rtm.length === 0;
          if (noTrupp && noRtm && patient.status !== "gemeldet") {
            patient.status = "gemeldet";
            patient.history = patient.history || [];
            patient.history.push(`${getCurrentTime()} Status: gemeldet`);
            dirty = true;
          }
        });

        if (dirty) {
          localStorage.setItem("patients", JSON.stringify(patients));
          loadPatients();
        }
      });

      // ENTER-Taste in Modal abfangen und bestätigen
      document.addEventListener("keydown", function (e) {
        const modal = document.getElementById("keywordModal");
        if (modal && modal.style.display === "flex" && e.key === "Enter") {
          e.preventDefault();
          confirmKeyword();
        }
      });

      // 1) Live-Timer updaten
      function updateLiveTimers() {
        const patients = JSON.parse(localStorage.getItem("patients")) || [];
        const now = Date.now();
        let dirty = false;

        patients.forEach((p) => {
          const isFinal =
            p.status === "Entlassen" || p.status === "Transport in KH";
          if (isFinal) return;
          const t = p.statusTimestamps || {};
          const d = (p.durations ||= {});
          const id = p.id;

          // 1) Einsatzdauer → läuft bis final
          if (!isFinal) {
            const val = formatMS(now - p.createdAt);
            const el = document.querySelector(
              `.timer.einsatzdauer[data-id='${id}']`
            );
            if (el) el.textContent = val;
            if (d.einsatzdauer !== val) {
              d.einsatzdauer = val;
              dirty = true;
            }
          }

          // 2) Dispositionsdauer → nur bis dispo gesetzt
          if (t.gemeldet && !t.disponiert) {
            const val = formatMS(now - t.gemeldet);
            const el = document.querySelector(
              `.timer.dispositionsdauer[data-id='${id}']`
            );
            if (el) el.textContent = val;
            if (d.dispositionsdauer !== val) {
              d.dispositionsdauer = val;
              dirty = true;
            }
          }

          // 3) Ausrückdauer → nur zwischen dispo und Behandlungs-/UHS-Start
          if (
            t.disponiert &&
            !t["in Behandlung"] &&
            !t["verlegt in UHS"] &&
            !t["Behandlung in UHS"]
          ) {
            const val = formatMS(now - t.disponiert);
            const el = document.querySelector(
              `.timer.ausrueckdauer[data-id='${id}']`
            );
            if (el) el.textContent = val;
            if (d.ausrueckdauer !== val) {
              d.ausrueckdauer = val;
              dirty = true;
            }
          }

          // 4) Verlegedauer UHS → von verlegt → Behandlung in UHS
          if (t["verlegt in UHS"] && !t["Behandlung in UHS"]) {
            const val = formatMS(now - t["verlegt in UHS"]);
            const el = document.querySelector(
              `.timer.verlegedauerUHS[data-id='${id}']`
            );
            if (el) el.textContent = val;
            if (d.verlegedauerUHS !== val) {
              d.verlegedauerUHS = val;
              dirty = true;
            }
          }

          // 5) Behandlungsdauer → läuft während in Behandlung oder UHS-Behandlung
          const behandlungsStart = t["in Behandlung"] ?? t["Behandlung in UHS"];
          if (behandlungsStart && !isFinal) {
            const val = formatMS(now - behandlungsStart);
            const el = document.querySelector(
              `.timer.behandlungsdauer[data-id='${id}']`
            );
            if (el) el.textContent = val;
            if (d.behandlungsdauer !== val) {
              d.behandlungsdauer = val;
              dirty = true;
            }
          }
        });
      }

      // weiter wie gehabt
      setInterval(updateLiveTimers, 1000);

      setInterval(updateLiveTimers, 1000);
    </script>
    <!-- Stichwort-Modal -->
    <div id="keywordModal" class="modal" style="display: none">
      <div class="modal-content">
        <span class="close" onclick="closeKeywordModal()">&times;</span>
        <h2>Stichwort auswählen</h2>

        <!-- ① Suchfeld -->
        <input
          type="text"
          id="searchInput"
          placeholder="Stichwort suchen…"
          style="
            width: 100%;
            padding: 6px;
            margin-bottom: 10px;
            box-sizing: border-box;
          "
          oninput="onSearchInput()"
        />

        <div style="display: flex; gap: 10px; height: 400px">
          <!-- ② Kategorien-Liste -->
          <div id="categoryList" class="list"></div>
          <!-- ③ Stichwort-Liste -->
          <div id="keywordList" class="list"></div>
          <!-- ④ Such-Ergebnis-Liste (initial versteckt) -->
          <div id="searchResults" class="list" style="display: none"></div>
        </div>

        <!-- Zusatzfeld für „sonstiger … Notfall“ -->
        <div id="otherDetail" style="margin-top: 10px; display: none">
          <label for="otherInput"
            ><strong>Bitte genauer beschreiben:</strong></label
          ><br />
          <input
            type="text"
            id="otherInput"
            style="width: 100%; padding: 6px; box-sizing: border-box"
          />
        </div>

        <button onclick="confirmKeyword()">Bestätigen</button>
      </div>
    </div>
  </body>
</html>
